---
title: "Chapter4: Latitude - Mass data"
author: "Elliott Schmidt"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true  
    toc_depth: 2
    toc_float: true
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: monochrome
    theme: cerulean
    latex_engine: xelatex
    
---

# Scenario 

Within this chapter developmental plasticity was explored within _Acanthochromis polyacanthus_ that were collected from two different regions (i.e., low-latitude, Cairns, and high-latitude, Mackay). Fish were held in common garden experiments at 28.5 C. Clutch data was collected along with parental morphometeric data to determine how fish from each population performed at 28.5 C, a temperature that was shown to produce similar absoluate aerobic scope performances in a previous study [link]. Once hatched offspring were placed into three different temperature treatments, 28.5, 30, and 31.5 C. After approximately 5-6 months offspring length and weight was measured, as well as CTmax and respiration during CTmax trials. 

# Load packages 

```{r load-packages-1, warning=FALSE, message=FALSE}
library(tidyverse) # data manipulation
library(ggpubr) # figure arrangement 
library(brms) # Bayesian models
library(StanHeaders)# needed to run Bayesian models
library(rstan) # needed to run Bayesian models
library(standist) # needs to be installed 
library(bayesplot) # needed for MCMC diagnostics 
library(DHARMa) # model validation 
library(ggdist) # partial plots 
library(tidybayes) # partial plots 
library(broom.mixed) # model investigation
library(emmeans) # pairwise comparisons
library(rstanarm) # pairwise comparisons - need for emmeans
library(car) # for vif
```

# Set working directory 

```{r setwd-1, echo=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude")
``` 

```{r setwd-2, echo=TRUE, eval=FALSE}
knitr::opts_knit$set(root.dir=working.dir)
```

# Import data 

```{r import-data-1, message=FALSE}
growth <- read_delim("./import_files/growth_data.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(NOTES = col_skip(), 
        ...16 = col_skip(), ...17 = col_skip()), 
    trim_ws = TRUE) 

clutch_data <- read_delim("import_files/clutch_data_2022_2023.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER))
```

# Data manipulation 

```{r data-manipulation-1, warning=FALSE}
density <- count(growth, CLUTCH_NUMBER, TANK) |> 
  rename(DENSITY = n) |> 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER), 
         TANK = as.factor(TANK)) 
growth2 <- growth |> 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER), 
         MALE = as.factor(MALE), 
         FEMALE = as.factor(FEMALE), 
         REGION = as.factor(REGION), 
         POPULATION = as.factor(POPULATION), 
         DATE_OF_HATCH = as.Date(DATE_OF_HATCH, format = "%d/%m/%Y"), 
         DATE_SAMPLED = as.Date(DATE_SAMPLED, format = "%d/%m/%Y"), 
         DEV_TEMP = as.factor(DEV_TEMP), 
         TANK = as.factor(TANK), 
         REP = as.factor(REP), 
         LENGTH = as.numeric(LENGTH), 
         MASS = as.numeric(MASS), 
         FULTONK = (1000*MASS)/(LENGTH^3), # Adding FULTON'S K metric
         EXPERIMENT = as.factor(EXPERIMENT)) |> 
  full_join(select(clutch_data, c("CLUTCH_NUMBER",
                                   "MALE_STANDARD_LENGTH", 
                                   "MALE_MASS", 
                                   "MALE_LAT", 
                                   "MALE_LONG", 
                                   "FEMALE_STANDARD_LENGTH", 
                                   "FEMALE_MASS", 
                                   "FEMALE_LAT", 
                                   "FEMALE_LONG", 
                                   "CLUTCH_ORDER", 
                                   "DAYS_IN_TREATMENT", 
                                   "EGG_COUNT", 
                                   "HATCHING_SUCCESS")), by = "CLUTCH_NUMBER") |> 
  select(c(1:6,16:27,7:13,15,14)) |> 
  drop_na(EXPERIMENT) |>
  mutate(CLUTCH_ORDER = as.factor(CLUTCH_ORDER), 
         EXP_GROUP = as.factor(paste0(REGION,"_",DEV_TEMP))) |> 
  inner_join(density, by=c("CLUTCH_NUMBER","TANK")) |> 
  mutate(FEMALE_MASS = coalesce(FEMALE_MASS, MALE_MASS),
         TANK =as.numeric(as.character(TANK)),
         LEVEL = as.factor(case_when(TANK >= 1 & TANK <= 199 ~ 1,
                           TANK >= 200 & TANK <= 299 ~ 2,
                           TANK >= 300 & TANK <= 399 ~ 3,
                           TRUE ~ NA_real_))) |> 
  mutate(TANK = as.factor(TANK)) |> 
  filter(MASS < 4, na.rm=TRUE, 
         FULTONK < 0.079, 
         FULTONK > 0.01, 
         DENSITY > 3)  
```

In the code above a number of variables were centered because within these metrics the value **0** is meaningless. For example you cannot have a fish length or mass of 0. Therefore, the mean was subtracted for a given variable was subtracted by every value. The y-intercept for these values will therefore reflect the mean, and the slope can be interpreted as 'y increases/decreases x amount for every 1-unit increase from the mean [INSERT METRIC]'. 


# Exploratory data analysis {.tabset}


## LENGTH VS. MASS

```{r eda-1, warning=FALSE, message=FALSE, echo=FALSE, fig.height=9, fig.width=9} 


p1 <- ggplot(growth2, aes(y=LENGTH, x=MASS)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("All points") +
  theme_classic();p1

p2 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=REGION)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Latitude") +
  theme_classic() + 
  theme(legend.position = "none") 

p3 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=POPULATION)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Population") +
  theme_classic()  + 
  theme(legend.position = "none") 

p4 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=CLUTCH_NUMBER)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("CLUTCH_NUMBER") +
  theme_classic() + 
  theme(legend.position = "none") 

p5 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=DEV_TEMP)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Developmetnal temperature") +
  theme_classic() + 
  theme(legend.position = "none")

eda1 <- ggarrange(p1,p2,p3,p4,p5, 
          ncol = 2, 
          nrow=3); eda1

```


## GROUP COMPARISONS

**NOTE:** On some of the figures ylimits have been set and therefore outliers are hidden

```{r eda-2, warning=FALSE, message=FALSE, fig.width=8, echo=FALSE}
plot.length.raw <- ggplot(growth2, aes(y=LENGTH, x=EXP_GROUP, fill=EXP_GROUP)) + 
  geom_boxplot(outlier.shape = NA) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, vjust=0.9, hjust=1)) + 
  scale_fill_manual(values = c("salmon","firebrick1","firebrick4","skyblue","steelblue3","royalblue4")) + 
  ggtitle("LENGTH")

plot.mass.raw <- ggplot(growth2, aes(y=MASS, x=EXP_GROUP, fill=EXP_GROUP)) + 
  geom_boxplot(outlier.shape = NA) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, vjust=0.9, hjust=1)) + 
  ylim(0,3) +
  scale_fill_manual(values = c("salmon","firebrick1","firebrick4","skyblue","steelblue3","royalblue4")) + 
  ggtitle("MASS") 

plot.k.raw <- ggplot(growth2, aes(y=FULTONK, x=EXP_GROUP, fill=EXP_GROUP)) + 
  geom_boxplot(outlier.shape = NA) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, vjust=0.9, hjust=1)) + 
  ylim(0.02,0.05) +
  scale_fill_manual(values = c("salmon","firebrick1","firebrick4","skyblue","steelblue3","royalblue4")) + 
  ggtitle("FULTON'S K") 

ggarrange(plot.length.raw,plot.mass.raw ,plot.k.raw, 
          ncol = 3, 
          nrow=1, 
          common.legend = TRUE, 
          legend = "bottom")
``` 

## distribution

```{r eda-3, warning=FALSE, message=FALSE, echo=FALSE}
p.length <- ggplot(growth2, aes(x=LENGTH)) + 
  geom_density()+
  theme_classic() 
p.mass <- ggplot(growth2, aes(x=MASS)) + 
  geom_density()+
  theme_classic() 

ggarrange(p.length,p.mass, 
          ncol=2, 
          nrow=1)
``` 

## Parent mass and length

```{r eda-4, warning=FALSE, message=FALSE}
male.mass.plot <- ggplot(growth2, aes(x=MALE_MASS, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Farther vs. offspring mass") +
  theme_classic() 

female.mass.plot <- ggplot(growth2, aes(x=FEMALE_MASS, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Mother vs. offspring mass") +
  theme_classic()  

male.length.plot <- ggplot(growth2, aes(x=MALE_STANDARD_LENGTH, y=LENGTH)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Farther vs. offspring length") +
  theme_classic() 

female.length.plot <- ggplot(growth2, aes(x=FEMALE_STANDARD_LENGTH, y=LENGTH)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Mother vs. offspring length") +
  theme_classic()  

ggarrange(male.mass.plot, female.mass.plot, male.length.plot, female.length.plot, 
          ncol=2, 
          nrow=2)
```

## Age 

```{r eda-5, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=5} 


p1 <- ggplot(growth2, aes(x=AGE_DAYS, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Age") +
  theme_classic();p1


#eda1 <- ggarrange(p1,p2,p3,p4,p5, 
          #ncol = 2, 
          #nrow=3); eda1

```
## Female Mass 

```{r eda-7, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=5} 


p1 <- ggplot(growth2, aes(x=FEMALE_MASS, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Age") +
  theme_classic();p1


#eda1 <- ggarrange(p1,p2,p3,p4,p5, 
          #ncol = 2, 
          #nrow=3); eda1

```

## Female Latitude 

```{r eda-8, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=5} 


p1 <- ggplot(growth2, aes(x=FEMALE_LAT, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Age") +
  theme_classic();p1


#eda1 <- ggarrange(p1,p2,p3,p4,p5, 
          #ncol = 2, 
          #nrow=3); eda1

```

## Density

```{r eda-density, warning=FALSE, message=FALSE, echo=FALSE, fig.height=4, fig.width=5} 


p1 <- ggplot(growth2, aes(x=DENSITY, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Age") +
  theme_classic();p1


#eda1 <- ggarrange(p1,p2,p3,p4,p5, 
          #ncol = 2, 
          #nrow=3); eda1

```

## {-}  

# Removal of outliers

There seems to be three areas that standout as potentially possessing outliers: 

1. The single individual that is >4 grams. This individual is more than double the size of the average individual. 
2. The cluster of individuals between 1 and 2grams that are below ~25 mm. Also there is no observable trend in this points (i.e., they are not all form the same developmental temperature, clutch, or population, which could have explained why they performed differently). 
3. Individuals that are floating above the main cluster. These could be individuals that grew rapidly and outcompeted diblings in their tank, or perhaps their tank had low density to begin with.  

Individuals identified in numbered points one and two are not unexpected. These data points will be double check to ensure they were entered correctly, if so they will be removed from the data set. 

It looks like there are some issues with the model. Mainly around the presence of outliers. Some of these outliers could be seen in our explanatory data analysis. Let's revisit our raw data to check and remove the presence of outliers. 


```{r outlier-removal-2}
growth3 <- growth2 |> 
  filter(MASS < 4, na.rm=TRUE, 
         FULTONK < 0.079, 
         FULTONK > 0.01, 
         DENSITY > 3)  
```

# Descriptive statistics 
```{r descriptive-statistics}
MinMax <- function(x) paste0('[', min(x, na.rm = TRUE), ', ', max(x, na.rm = TRUE), ']') 
Range <- function(x) max(x, na.rm = TRUE) - min(x, na.rm = TRUE)
datasummary(REGION (LENGTH + MASS) + (LENGTH + MASS) ~  median + MinMax + Range + Histogram, 
            data=growth3)
datasummary(REGION * DEV_TEMP * (LENGTH + MASS) + (LENGTH + MASS) ~  median + MinMax + Range + Histogram, 
            data=growth3)
```


note this also removes NA's therefore the difference in data frames is 21 row: 

* 1 datum point with MASS greater than 4  
* 1 datum point with high value (removed via FULTONK being less than 0.01) 
* 2 data points where the tank density was 2
* 9 data points with low values (removed via FULTONK being greater than 0.079)
* 8 NA's removed 
* **Total: 21** 

Now Let's look at out plots again 

```{r outlier-removal-4,  warning=FALSE, message=FALSE, echo=FALSE, fig.height=9, fig.width=9}
p1.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("All points") +
  theme_classic()

p2.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=REGION)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) +  
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Latitude") +
  theme_classic() + 
  theme(legend.position = "none") 

p3.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=POPULATION)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Population") +
  theme_classic() +
  theme(legend.position = "none")

p4.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=CLUTCH_NUMBER)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) +  
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("CLUTCH_NUMBER") +
  theme_classic() + 
  theme(legend.position = "none") 

p5.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=DEV_TEMP)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) +  
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Developmetnal temperature") +
  theme_classic() + 
  theme(legend.position = "none")

eda2 <- ggarrange(p1.wo,p2.wo,p3.wo,p4.wo,p5.wo, 
          ncol = 2, 
          nrow=3); eda2
```


# Fit model [random factors] {.tabset}


First we will place random factors only within out model and see if they do a good job explaining the variance within our model. We will also be include priors which will be based off of out length data. 

Hypothesis test will include:

0. Null model
1. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK)
2. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK) + (1| LEVEL)
3. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK) + (1| LEVEL) + (1| POPULATION)
4. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK) + (1| LEVEL) + (1| POPULATION)+ (1| CLUTCH_ORDER)

```{r}
growth3 |> 
  group_by(REGION,DEV_TEMP) |> 
  summarise(mean(na.omit(MASS)), 
            sd(na.omit(MASS))) 
```

## Priors 
```{r prior-investigation-random-factors}
mass.priors.re <- prior(normal(1.13, 0.20), class="Intercept") +  
  prior(student_t(3, 0, 0.53), class = "sigma")
```

## Models {.tabset}

### Null 
```{r null, cache=TRUE}
f.model.null <- bf(MASS ~ 1, 
                   family = gaussian()) 

model.null <- brm(f.model.null,
              data = growth3, 
              prior = mass.priors.re,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model.null, file="./02.mass_data_analysis_files/model.null.RDS")
```


### Model1
```{r fit-model1, cache=TRUE} 
f.model1 <- bf(MASS ~ 1 + (1|FEMALE) + (1|TANK), 
                          family=gaussian())

model1 <- brm(f.model1,
              data = growth3, 
              prior = mass.priors.re,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1, file="./02.mass_data_analysis_files/model1.RDS")
```

### Model2
```{r fit-model2, cache=TRUE} 
f.model2 <- bf(MASS ~ 1 + (1|FEMALE) + (1|TANK) + (1| LEVEL), 
                          family=gaussian())

model2 <- brm(f.model2,
              data = growth3, 
              prior = mass.priors.re,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model2, file="./02.mass_data_analysis_files/model2.RDS")
```

### Model3
```{r fit-model3, cache=TRUE}  
f.model3 <- bf(MASS ~ 1 + (1| FEMALE) + (1| TANK) + (1|LEVEL) + (1| POPULATION), 
               family=gaussian())

model3 <- brm(f.model3,
              data = growth3, 
              prior = mass.priors.re,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model3, file="./02.mass_data_analysis_files/model3.RDS")
```

### Model4
```{r fit-model4, cache=TRUE} 
f.model4 <- bf(MASS ~ 1 + (1|FEMALE) + (1 |TANK) + (1| LEVEL) + (1| POPULATION)+ (1|CLUTCH_ORDER), 
                        family=gaussian())

model4 <- brm(f.model4,
              data = growth3, 
              prior = mass.priors.re,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model4, file="./02.mass_data_analysis_files/model4.RDS")
```

### {-}

## LOO
```{r model-comparisons-2}
LOO(model.null,model1, model2,model3,model4) 
```

## {-}

CLUTCH_ORDER **does not** improve the model. Therefore it will not be used moving forward. 

# Fit model [fixed factors] 

## Collinearity 
```{r }
col.lm <- lm(MASS ~ 1 + DEV_TEMP+REGION + 
                         scale(FEMALE_MASS, center=TRUE, scale=TRUE) + 
                         scale(DENSITY, center=TRUE, scale=TRUE) + 
                         scale(AGE_DAYS, center=TRUE, scale=TRUE) +
                         scale(LENGTH, center=TRUE, scale=TRUE), 
                data = growth3)
vif(col.lm)
``` 

## Prior investigation 
```{r }
growth3 |> 
  group_by(REGION,DEV_TEMP) |> 
  summarise(mean(na.omit(MASS)), 
            sd(na.omit(MASS))) 
```

## Priors
```{r }
mass.priors <- prior(normal(1.13, 0.20), class="Intercept") +  
  prior(normal(0, 0.25), class="b") +
  prior(student_t(3, 0, 0.53), class = "sigma")
```

## Models {.tabset}

### Model3.1 {.tabset}

#### Model

```{r model3.1, cache=TRUE}
f.model3.1 <- bf(MASS ~ 1 + 
                         DEV_TEMP*REGION +  
                         scale(DENSITY, center=TRUE, scale=TRUE) + 
                         #scale(AGE_DAYS, center=TRUE, scale=TRUE) +
                         scale(LENGTH, center=TRUE, scale=TRUE) + 
                         (1| FEMALE) + (1| TANK) + (1|LEVEL) + (1| POPULATION), 
                         family=gaussian()) 

model3.1 <- brm(f.model3.1,
              data = growth3, 
              prior = mass.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model3.1, file="./02.mass_data_analysis_files/model3.1.RDS")
```

#### DHARMa
```{r model3.1-DHARMa}
#--- distribution check ---#
pp_check(model3.1, type = 'dens_overlay')

#--- DHARMa checks ---#
preds <- posterior_predict(model3.1, ndraws=250, summary=FALSE)
model3.1_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = growth3$MASS, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model3.1_resids) ; testDispersion(model3.1_resids)
```

#### MCMC Diagnostics

```{r model3.1-mcmc-diag, fig.height=9}
stan_trace(model3.1$fit)
stan_ac(model3.1$fit) 
stan_rhat(model3.1$fit) 
stan_ess(model3.1$fit)
stan_dens(model3.1$fit, separate_chains = TRUE)
```

#### {-}

### Model3.2 (polynomial model) {.tabset}
#### Model
```{r model3.2, cache=TRUE}
f.model3.2 <- bf(MASS ~ 1 + 
                         DEV_TEMP*REGION + 
                         scale(DENSITY, center=TRUE, scale=TRUE) + 
                         #scale(AGE_DAYS, center=TRUE, scale=TRUE) +
                         poly(scale(LENGTH, center=TRUE, scale=TRUE), 2) + 
                         (1| FEMALE) + (1| TANK) + (1|LEVEL) + (1| POPULATION), 
                         family=gaussian()) 

model3.2 <- brm(f.model3.2,
              data = growth3, 
              prior = mass.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model3.2, file="./02.mass_data_analysis_files/model3.2.RDS")
```

#### DHARMa
```{r model3.2-DHARMa}
#--- distribution check ---#
pp_check(model3.2, type = 'dens_overlay')

#--- DHARMa checks ---#
preds <- posterior_predict(model3.2, ndraws=250, summary=FALSE)
model3.2_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = growth3$MASS, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model3.2_resids) ; testDispersion(model3.2_resids)
```

#### MCMC Diagnostics

```{r model3.2-mcmc-diag, fig.height=9}
stan_trace(model3.2$fit)
stan_ac(model3.2$fit) 
stan_rhat(model3.2$fit) 
stan_ess(model3.2$fit)
stan_dens(model3.2$fit, separate_chains = TRUE)
```

#### {-}

### LOO 
```{r model-comparisons-3}
LOO(model3.1, model3.2) 
```

### {-}

# 

There are issues with this model lets fit it using a Gamma distribution. 

**Note:** The Gamma distribution will have a log link function. 

# Re-fit model [gamma]

```{r model3.3_gamma1-priors}
model_gamma.priors <- prior(normal(1.13, 0.20), class="Intercept") +  
  prior(normal(0, 0.25), class="b")
```

## Model3.1_gamma1 {.tabset}
### Model
```{r model3.3_gamma1, cache=TRUE}
f.model3.1_gamma1 <- bf(MASS ~ 1 + 
                         DEV_TEMP*REGION +  
                         scale(DENSITY, center=TRUE, scale=TRUE) + 
                         #scale(AGE_DAYS, center=TRUE, scale=TRUE) +
                         scale(LENGTH, center=TRUE, scale=TRUE) +  
                         (1| FEMALE) + (1| TANK) + (1|LEVEL) + (1| POPULATION), 
                         family=Gamma(link = "log"))

model3.1_gamma1 <- brm(f.model3.1_gamma1,
              data = growth3, 
              prior = model_gamma.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              sample_prior = "yes",
              save_pars = save_pars(all=TRUE),  
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95))  
saveRDS(model3.1_gamma1, file="./02.mass_data_analysis_files/model3.1_gamma1.RDS")
```

### DHARMa
```{r model3.1_gamma1-DHARMa}
#--- distribution check ---#
pp_check(model3.1_gamma1, type = 'dens_overlay')

#--- DHARMa checks ---#
preds <- posterior_predict(model3.1_gamma1, ndraws=250, summary=FALSE)
model3.1_gamma1_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = growth3$MASS, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model3.1_gamma1_resids) ; testDispersion(model3.1_gamma1_resids); testDispersion(model3.1_gamma1_resids, plot = F, alternative = "greater")
```

### MCMC Diagnostics

```{r model3.3_gamma1-mcmc-diag, fig.height=9}
stan_trace(model3.1_gamma1$fit)
stan_ac(model3.1_gamma1$fit) 
stan_rhat(model3.1_gamma1$fit) 
stan_ess(model3.1_gamma1$fit)
stan_dens(model3.1_gamma1$fit, separate_chains = TRUE)
```

#### {-}

# Partial effects plots 

## conditional_effects 

```{r partial-plots-cond-eff-1}
model3.1_gamma1 |> 
  conditional_effects(spaghetti = TRUE, ndraws=200) 
``` 

# Model investigation {.tabset}

## summary 

```{r summary-100}
summary(model3.1_gamma1)
#car::Anova(model1.geo.gamma)
```

## R2 

```{r r-squared}
model3.1_gamma1 |> bayes_R2(summary = FALSE) |> median_hdci()
```

## tidyMCMC 

```{r tidy}
tidyMCMC(model3.1_gamma1, estimate.method='median', conf.int=TRUE, conf.method='HPDinterval')
```

## gather draws 

```{r gather_draws}
#model1.re.wo |> get_variables()
model3.1_gamma1 |> gather_draws(`b_.*|sigma`, regex =TRUE) |> 
  median_hdci()

#temp <- int_draws_plotting |>
  #group_by(EXP_GROUP) |> 
  #summarise(Median = median_hdci(MASS))
``` 

## bayesplot 

```{r bayesplot-1}
model3.1_gamma1 |> mcmc_plot(type='intervals')
```

## emmeans - pariwise 

```{r emmeans-pairwise}
model3.1_gamma1 |> emmeans(pairwise ~ REGION*DEV_TEMP, type="response") |> pairs(by="DEV_TEMP") |> summary(infer=TRUE)

model3.1_gamma1 |> emmeans(pairwise ~ REGION*DEV_TEMP, type="response") |> pairs(by="REGION") |> confint()

model3.1_gamma1 |> emmeans(pairwise ~ REGION*DEV_TEMP, type="response") |> regrid() 

```

## probabilities 
```{r probabilities}
#model1.geo.gamma |> emmeans(~ REGION | DEV_TEMP, at = list(DEV_TEMP = 31.5, length.out = 10)) |> pairs(type = 'response')
mtsqst <- model3.1_gamma1 |> emmeans(pairwise ~ REGION*DEV_TEMP)
mtsqrt2 <- mtsqst$contrasts |> gather_emmeans_draws()
mtsqrt2 %>% group_by(contrast) %>% dplyr::summarise(Prob = sum(.value<0)/n())
```

## {-}

# summary figure 

```{r summary-figure-1, warning=FALSE, message=FALSE}
var <- get_variables(model3.1_gamma1)
var1 <- get_variables(model3.1_gamma1)[c(1:4,7,8)] 

int_draws_spread <- model3.1_gamma1 |> spread_draws(!!!syms(var1)) 

int_draws_spread2 <- int_draws_spread |> 
  gather_draws(b_Intercept, b_REGIONleading) |> 
  left_join(int_draws_spread, by = c(".chain",".iteration",".draw"))
  
  
int_draws <- int_draws_spread2 |> 
  mutate(x28.5 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value`, 
                               `.variable` != 'b_Intercept' ~ 
                                 `.value` + b_Intercept), 
         
         x30 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value` + b_DEV_TEMP30, 
                             `.variable` == 'b_REGIONleading' ~ 
                                 `.value` + b_Intercept + b_DEV_TEMP30 + `b_DEV_TEMP30:REGIONleading`), 
         
         x31.5 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value` + b_DEV_TEMP31.5, 
                             `.variable` == 'b_REGIONleading' ~ 
                                 `.value` + b_Intercept + b_DEV_TEMP31.5 + `b_DEV_TEMP31.5:REGIONleading`))
  
int_draws_plotting <- int_draws |> 
  pivot_longer(cols = starts_with("x"), 
               names_to = "DEV_TEMP", 
               values_to = "MASS") |> 
  transmute(LATITUDE = case_when(`.variable` == "b_Intercept" ~ "Low latitude", 
                                 `.variable` == "b_REGIONleading" ~ "High latitude"), 
            DEV_TEMP = case_when(DEV_TEMP == 'x28.5' ~ 'DEV_TEMP_28.5', 
                                 DEV_TEMP == 'x30' ~ 'DEV_TEMP_30', 
                                 DEV_TEMP == 'x31.5' ~ 'DEV_TEMP_31.5'),
            MASS = MASS, 
            LATITUDE_B = LATITUDE, 
            DEV_TEMP_B = DEV_TEMP,
            chain = `.chain`, 
            iteration = `.iteration`, 
            draw_n = `.draw`) |> 
  unite("EXP_GROUP",LATITUDE_B, DEV_TEMP_B,sep="_") |> 
  mutate(EXP_GROUP = as.factor(EXP_GROUP)) |> 
  mutate(EXP_GROUP = factor(EXP_GROUP, levels=c("High latitude_DEV_TEMP_28.5","High latitude_DEV_TEMP_30", "High latitude_DEV_TEMP_31.5",
                                                "Low latitude_DEV_TEMP_28.5","Low latitude_DEV_TEMP_30", "Low latitude_DEV_TEMP_31.5")))


mass.plot <- int_draws_plotting |> 
  ggplot(aes(x=EXP_GROUP, y=MASS)) + 
  #geom_hline(yintercept = 0, linetype="dashed", linewidth=1, color="grey58", alpha=0.8) + 
  stat_halfeye(aes(fill = EXP_GROUP, fill_ramp = after_stat(level)), 
               point_interval = median_hdci, 
               .width = c(.66, .89, .95)) + 
  scale_fill_ramp_discrete(na.translate=FALSE, 
                           labels =c("0.95","0.89","0.66"), 
                           name = "Credible interval") +
  scale_fill_manual(values = c("lightskyblue" ,"dodgerblue2", "dodgerblue4","coral", "red2","firebrick4"))+ 
  scale_y_continuous(limits=c(0,2), breaks = seq(0,2, .5))+
  ylab("MASS (g)") + xlab("EXPERIMENTAL GROUP") +
  scale_x_discrete(labels = c("Low latitude_DEV_TEMP_28.5" = paste0("Low latitude 28.5","\u00B0","C"), 
                              "Low latitude_DEV_TEMP_30" = paste0("Low latitude 30","\u00B0","C"),
                              "Low latitude_DEV_TEMP_31.5" = paste0("Low latitude 31.5","\u00B0","C"), 
                              "High latitude_DEV_TEMP_28.5" = paste0("High latitude 28.5","\u00B0","C"),
                              "High latitude_DEV_TEMP_30" = paste0("High latitude 30","\u00B0","C"),
                              "High latitude_DEV_TEMP_31.5" = paste0("High latitude 31.5","\u00B0","C"))) +
  #annotate("text", x=6.8,y=1.4, label = paste0(round(mean(growth3$MASS), 2)," (mm)"), color="grey58") +
  coord_flip() + 
  theme_classic() + 
  guides(fill = "none") + 
  theme(legend.position = c(.15,.86), 
        axis.title.y = element_text(margin = margin(r =0.3, unit = "in"), size = 12), 
        axis.title.x = element_text(margin = margin(t = 0.3, unit="in"), size =12), 
        legend.key = element_rect(color="black", size=1.25), 
        legend.background = element_rect(fill = alpha("blue", 0))); mass.plot
```

```{r eval=FALSE, echo=TRUE}
#ggsave(file="./figures/mass.plot.svg",  plot=mass.plot, width=8, height=5, units = "in", dpi=300) 
#ggsave(file="./figures/mass.plot.pdf",  plot=mass.plot, width=8, height=5, units = "in", dpi=300)
```

# just growth 


```{r model3.3_growth-priors}
model_gamma.priors <- prior(normal(1.13, 0.20), class="Intercept") +  
  prior(normal(0, 0.25), class="b")
```

## Model3.1_gamma1 {.tabset}
### Model
```{r model3.3_growth-sio, cache=TRUE}
f.model3.1.nolength <- bf(MASS ~ 1 + 
                         DEV_TEMP*REGION +  
                         scale(DENSITY, center=TRUE, scale=TRUE) + 
                         #scale(AGE_DAYS, center=TRUE, scale=TRUE) +
                         #scale(LENGTH, center=TRUE, scale=TRUE) +  
                         (1| FEMALE) + (1| TANK) + (1|LEVEL) + (1| POPULATION), 
                         family=Gamma(link = "log"))

model3.1.nolength <- brm(f.model3.1.nolength,
              data = growth3, 
              prior = model_gamma.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              sample_prior = "yes",
              save_pars = save_pars(all=TRUE),  
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95))  
saveRDS(model3.1.nolength, file="./02.mass_data_analysis_files/model3.1_growth_nolength.RDS")
```

# summary figure 

```{r summary-figure-2, warning=FALSE, message=FALSE}
var <- get_variables(model3.1.nolength)
var1 <- get_variables(model3.1.nolength)[c(1:4,6,7)] 

int_draws_spread <- model3.1.nolength |> spread_draws(!!!syms(var1)) 

int_draws_spread2 <- int_draws_spread |> 
  gather_draws(b_Intercept, b_REGIONleading) |> 
  left_join(int_draws_spread, by = c(".chain",".iteration",".draw"))
  
  
int_draws <- int_draws_spread2 |> 
  mutate(x28.5 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value`, 
                               `.variable` != 'b_Intercept' ~ 
                                 `.value` + b_Intercept), 
         
         x30 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value` + b_DEV_TEMP30, 
                             `.variable` == 'b_REGIONleading' ~ 
                                 `.value` + b_Intercept + b_DEV_TEMP30 + `b_DEV_TEMP30:REGIONleading`), 
         
         x31.5 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value` + b_DEV_TEMP31.5, 
                             `.variable` == 'b_REGIONleading' ~ 
                                 `.value` + b_Intercept + b_DEV_TEMP31.5 + `b_DEV_TEMP31.5:REGIONleading`))
  
int_draws_plotting <- int_draws |> 
  pivot_longer(cols = starts_with("x"), 
               names_to = "DEV_TEMP", 
               values_to = "MASS") |> 
  transmute(LATITUDE = case_when(`.variable` == "b_Intercept" ~ "Low latitude", 
                                 `.variable` == "b_REGIONleading" ~ "High latitude"), 
            DEV_TEMP = case_when(DEV_TEMP == 'x28.5' ~ 'DEV_TEMP_28.5', 
                                 DEV_TEMP == 'x30' ~ 'DEV_TEMP_30', 
                                 DEV_TEMP == 'x31.5' ~ 'DEV_TEMP_31.5'),
            MASS = MASS, 
            LATITUDE_B = LATITUDE, 
            DEV_TEMP_B = DEV_TEMP,
            chain = `.chain`, 
            iteration = `.iteration`, 
            draw_n = `.draw`) |> 
  unite("EXP_GROUP",LATITUDE_B, DEV_TEMP_B,sep="_") |> 
  mutate(EXP_GROUP = as.factor(EXP_GROUP)) |> 
  mutate(EXP_GROUP = factor(EXP_GROUP, levels=c("High latitude_DEV_TEMP_28.5","High latitude_DEV_TEMP_30", "High latitude_DEV_TEMP_31.5",
                                                "Low latitude_DEV_TEMP_28.5","Low latitude_DEV_TEMP_30", "Low latitude_DEV_TEMP_31.5")))


mass.plot <- int_draws_plotting |> 
  ggplot(aes(x=EXP_GROUP, y=MASS)) + 
  #geom_hline(yintercept = 0, linetype="dashed", linewidth=1, color="grey58", alpha=0.8) + 
  stat_halfeye(aes(fill = EXP_GROUP, fill_ramp = after_stat(level)), 
               point_interval = median_hdci, 
               .width = c(.66, .89, .95)) + 
  scale_fill_ramp_discrete(na.translate=FALSE, 
                           labels =c("0.95","0.89","0.66"), 
                           name = "Credible interval") +
  scale_fill_manual(values = c("lightskyblue" ,"dodgerblue2", "dodgerblue4","coral", "red2","firebrick4"))+ 
  scale_y_continuous(limits=c(0,2), breaks = seq(0,2, .5))+
  ylab("MASS (g)") + xlab("EXPERIMENTAL GROUP") +
  scale_x_discrete(labels = c("Low latitude_DEV_TEMP_28.5" = paste0("Low latitude 28.5","\u00B0","C"), 
                              "Low latitude_DEV_TEMP_30" = paste0("Low latitude 30","\u00B0","C"),
                              "Low latitude_DEV_TEMP_31.5" = paste0("Low latitude 31.5","\u00B0","C"), 
                              "High latitude_DEV_TEMP_28.5" = paste0("High latitude 28.5","\u00B0","C"),
                              "High latitude_DEV_TEMP_30" = paste0("High latitude 30","\u00B0","C"),
                              "High latitude_DEV_TEMP_31.5" = paste0("High latitude 31.5","\u00B0","C"))) +
  #annotate("text", x=6.8,y=1.4, label = paste0(round(mean(growth3$MASS), 2)," (mm)"), color="grey58") +
  coord_flip() + 
  theme_classic() + 
  guides(fill = "none") + 
  theme(legend.position = c(.15,.86), 
        axis.title.y = element_text(margin = margin(r =0.3, unit = "in"), size = 12), 
        axis.title.x = element_text(margin = margin(t = 0.3, unit="in"), size =12), 
        legend.key = element_rect(color="black", size=1.25), 
        legend.background = element_rect(fill = alpha("blue", 0))); mass.plot
```