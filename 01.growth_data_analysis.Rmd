---
title: "Chapter4: Latitude - Growth Data"
author: "Elliott Schmidt"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true  
    toc_depth: 2
    toc_float: true
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: monochrome
    theme: cerulean
    latex_engine: xelatex
    
---
# Scenario 

Within this chapter developmental plasticity was explored within _Acanthochromis polyacanthus_ that were collected from two different regions (i.e., low-latitude, Cairns, and high-latitude, Mackay). Fish were held in common garden experiments at 28.5 C. Clutch data was collected along with parental morphometeric data to determine how fish from each population performed at 28.5 C, a temperature that was shown to produce similar absoluate aerobic scope performances in a previous study [link]. Once hatched offspring were placed into three different temperature treatments, 28.5, 30, and 31.5 C. After approximately 5-6 months offspring length and weight was measured, as well as CTmax and respiration during CTmax trials. 

# Load packages 

```{r load-packages-1, warning=FALSE, message=FALSE}
library(tidyverse) # data manipulation
library(ggpubr) # figure arrangement 
library(brms) # Bayesian models
library(StanHeaders)# needed to run Bayesian models
library(rstan) # needed to run Bayesian models
library(standist) # needs to be installed 
library(bayesplot) # needed for MCMC diagnostics 
library(DHARMa) # model validation 
library(ggdist) # partial plots 
library(tidybayes) # partial plots 
library(broom.mixed) # model investigation
library(emmeans) # pairwise comparisons
library(rstanarm) # pairwise comparisons - need for emmeans
```

# Set working directory 

```{r setwd-1, echo=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude")
``` 

```{r setwd-2, echo=TRUE, eval=FALSE}
knitr::opts_knit$set(root.dir=working.dir)
```

# Import data 

```{r import-data-1, message=FALSE}
growth <- read_delim("import_files/growth_data.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(NOTES = col_skip(), 
        ...16 = col_skip(), ...17 = col_skip()), 
    trim_ws = TRUE) 

clutch_data <- read_delim("import_files/clutch_data_2022_2023.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) %>% 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER))
```

# Data manipulation 

```{r data-manipulation-1, warning=FALSE}
density <- count(growth, CLUTCH_NUMBER, TANK) |> 
  rename(DENSITY = n) |> 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER), 
         TANK = as.factor(TANK)) 
growth2 <- growth |> 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER), 
         MALE = as.factor(MALE), 
         FEMALE = as.factor(FEMALE), 
         REGION = as.factor(REGION), 
         POPULATION = as.factor(POPULATION), 
         DATE_OF_HATCH = as.Date(DATE_OF_HATCH, format = "%d/%m/%Y"), 
         DATE_SAMPLED = as.Date(DATE_SAMPLED, format = "%d/%m/%Y"), 
         DEV_TEMP = as.factor(DEV_TEMP), 
         TANK = as.factor(TANK), 
         REP = as.factor(REP), 
         LENGTH = as.numeric(LENGTH), 
         MASS = as.numeric(MASS), 
         FULTONK = (1000*MASS)/(LENGTH^3), # Adding FULTON'S K metric
         EXPERIMENT = as.factor(EXPERIMENT)) |> 
  full_join(select(clutch_data, c("CLUTCH_NUMBER",
                                   "MALE_STANDARD_LENGTH", 
                                   "MALE_MASS", 
                                   "MALE_LAT", 
                                   "MALE_LONG", 
                                   "FEMALE_STANDARD_LENGTH", 
                                   "FEMALE_MASS", 
                                   "FEMALE_LAT", 
                                   "FEMALE_LONG", 
                                   "CLUTCH_ORDER", 
                                   "DAYS_IN_TREATMENT", 
                                   "EGG_COUNT", 
                                   "HATCHING_SUCCESS")), by = "CLUTCH_NUMBER") |> 
  select(c(1:6,16:27,7:13,15,14)) |> 
  drop_na(EXPERIMENT) |>
  mutate(CLUTCH_ORDER = as.factor(CLUTCH_ORDER), 
         EXP_GROUP = as.factor(paste0(REGION,"_",DEV_TEMP))) |> 
  inner_join(density, by=c("CLUTCH_NUMBER","TANK")) |> 
  mutate(cLENGTH = scale(LENGTH, scale = FALSE)[,1], 
         cMASS = scale(MASS, scale=FALSE)[,1], 
         cFULTONK = scale(FULTONK, scale=FALSE)[,1], 
         cMALE_STANDARD_LENGTH = scale(MALE_STANDARD_LENGTH, scale=FALSE)[,1], 
         cMALE_MASS = scale(MALE_MASS, scale=FALSE)[,1], 
         cFEMALE_STANDARD_LENGTH = scale(MALE_STANDARD_LENGTH, scale=FALSE)[,1], 
         cFEMALE_MASS = scale(MALE_MASS, scale=FALSE)[,1], 
         cDENSITY = scale(DENSITY, scale=FALSE)[,1], 
         cAGE_DAYS = scale(AGE_DAYS, scale=FALSE)[,1],
         TANK = as.numeric(as.character(TANK)),
         LEVEL = as.factor(case_when(TANK >= 1 & TANK <= 199 ~ 1,
                           TANK >= 200 & TANK <= 299 ~ 2,
                           TANK >= 300 & TANK <= 399 ~ 3,
                           TRUE ~ NA_real_))) |> 
  mutate(TANK = as.factor(TANK))
```

In the code above a number of variables were centered because within these metrics the value **0** is meaningless. For example you cannot have a fish length or mass of 0. Therefore, the mean was subtracted for a given variable was subtracted by every value. The y-intercept for these values will therefore reflect the mean, and the slope can be interpreted as 'y increases/decreases x amount for every 1-unit increase from the mean [INSERT METRIC]'. 


# Exploratory data analysis {.tabset}


## LENGTH VS. MASS

```{r eda-1, warning=FALSE, message=FALSE, echo=FALSE, fig.height=9, fig.width=9} 


p1 <- ggplot(growth2, aes(y=LENGTH, x=MASS)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("All points") +
  theme_classic();p1

p2 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=REGION)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Latitude") +
  theme_classic() + 
  theme(legend.position = "none") 

p3 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=POPULATION)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Population") +
  theme_classic()  + 
  theme(legend.position = "none") 

p4 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=CLUTCH_NUMBER)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("CLUTCH_NUMBER") +
  theme_classic() + 
  theme(legend.position = "none") 

p5 <- ggplot(growth2, aes(y=LENGTH, x=MASS, color=DEV_TEMP)) + 
  geom_point(alpha = 0.5) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Developmetnal temperature") +
  theme_classic() + 
  theme(legend.position = "none")

eda1 <- ggarrange(p1,p2,p3,p4,p5, 
          ncol = 2, 
          nrow=3); eda1

```


## GROUP COMPARISONS

**NOTE:** On some of the figures ylimits have been set and therefore outliers are hidden

```{r eda-2, warning=FALSE, message=FALSE, fig.width=8, echo=FALSE}
plot.length.raw <- ggplot(growth2, aes(y=LENGTH, x=EXP_GROUP, fill=EXP_GROUP)) + 
  geom_boxplot() + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, vjust=0.9, hjust=1)) + 
  scale_fill_manual(values = c("salmon","firebrick1","firebrick4","skyblue","steelblue3","royalblue4")) + 
  ggtitle("LENGTH")

plot.mass.raw <- ggplot(growth2, aes(y=MASS, x=EXP_GROUP, fill=EXP_GROUP)) + 
  geom_boxplot() + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, vjust=0.9, hjust=1)) + 
  ylim(0,3) +
  scale_fill_manual(values = c("salmon","firebrick1","firebrick4","skyblue","steelblue3","royalblue4")) + 
  ggtitle("MASS") 

plot.k.raw <- ggplot(growth2, aes(y=FULTONK, x=EXP_GROUP, fill=EXP_GROUP)) + 
  geom_boxplot() + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle=45, vjust=0.9, hjust=1)) + 
  ylim(0.02,0.05) +
  scale_fill_manual(values = c("salmon","firebrick1","firebrick4","skyblue","steelblue3","royalblue4")) + 
  ggtitle("FULTON'S K") 

ggarrange(plot.length.raw,plot.mass.raw ,plot.k.raw, 
          ncol = 3, 
          nrow=1, 
          common.legend = TRUE, 
          legend = "bottom")
``` 

## distribution

```{r eda-3, warning=FALSE, message=FALSE, echo=FALSE}
p.length <- ggplot(growth2, aes(x=LENGTH)) + 
  geom_density()+
  theme_classic() 
p.mass <- ggplot(growth2, aes(x=MASS)) + 
  geom_density()+
  theme_classic() 

ggarrange(p.length,p.mass, 
          ncol=2, 
          nrow=1)
``` 

## Parent mass and length

```{r eda-4, warning=FALSE, message=FALSE}
male.mass.plot <- ggplot(growth2, aes(x=MALE_MASS, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Farther vs. offspring mass") +
  theme_classic() 

female.mass.plot <- ggplot(growth2, aes(x=FEMALE_MASS, y=MASS)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Mother vs. offspring mass") +
  theme_classic()  

male.length.plot <- ggplot(growth2, aes(x=MALE_STANDARD_LENGTH, y=LENGTH)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Farther vs. offspring length") +
  theme_classic() 

female.length.plot <- ggplot(growth2, aes(x=FEMALE_STANDARD_LENGTH, y=LENGTH)) + 
  geom_point(alpha = 0.5) + 
  ggtitle("Mother vs. offspring length") +
  theme_classic()  

ggarrange(male.mass.plot, female.mass.plot, male.length.plot, female.length.plot, 
          ncol=2, 
          nrow=2)
```
# {-} 

# Removal of outliers

There seems to be three areas that standout as potentially possessing outliers: 

1. The single individual that is >4 grams. This individual is more than double the size of the average individual. 
2. The cluster of individuals between 1 and 2grams that are below ~25 mm. Also there is no observable trend in this points (i.e., they are not all form the same developmental temperature, clutch, or population, which could have explained why they performed differently). 
3. Individuals that are floating above the main cluster. These could be individuals that grew rapidly and outcompeted diblings in their tank, or perhaps their tank had low density to begin with.  

Individuals identified in numbered points one and two are not unexpected. These data points will be double check to ensure they were entered correctly, if so they will be removed from the data set. 

It looks like there are some issues with the model. Mainly around the presence of outliers. Some of these outliers could be seen in our explanatory data analysis. Let's revisit our raw data to check and remove the presence of outliers. 


```{r outlier-removal-2}
growth3 <- growth2 |> 
  filter(MASS < 4, na.rm=TRUE, 
         FULTONK < 0.079, 
         FULTONK > 0.01, 
         DENSITY > 3)  
```



note this also removes NA's therefore the difference in data frames is 21 row: 

* 1 datum point with MASS greater than 4  
* 1 datum point with high value (removed via FULTONK being less than 0.01) 
* 2 data points where the tank density was 2
* 9 data points with low values (removed via FULTONK being greater than 0.079)
* 8 NA's removed 
* **Total: 21** 

Now Let's look at out plots again 

```{r outlier-removal-4,  warning=FALSE, message=FALSE, echo=FALSE, fig.height=9, fig.width=9}
p1.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("All points") +
  theme_classic()

p2.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=REGION)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) +  
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Latitude") +
  theme_classic() + 
  theme(legend.position = "none") 

p3.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=POPULATION)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) + 
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Population") +
  theme_classic() +
  theme(legend.position = "none")

p4.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=CLUTCH_NUMBER)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) +  
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("CLUTCH_NUMBER") +
  theme_classic() + 
  theme(legend.position = "none") 

p5.wo <- ggplot(growth3, aes(y=LENGTH, x=MASS, color=DEV_TEMP)) + 
  geom_point(data = growth2, aes(y=LENGTH, x=MASS), 
             shape = 8, color = "red") +
  geom_point(alpha = 0.9, size = 3) +  
  geom_smooth(methos="lm", se=TRUE, fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  ggtitle("Developmetnal temperature") +
  theme_classic() + 
  theme(legend.position = "none")

eda2 <- ggarrange(p1.wo,p2.wo,p3.wo,p4.wo,p5.wo, 
          ncol = 2, 
          nrow=3); eda2
```

# Fit model [random factors]

First we will place random factors only within out model and see if they do a good job explaining the variance within our model. We will also be include piors which will be based off of out length data.

## Prior investigation 
```{r }
growth3 |> 
  group_by(REGION,DEV_TEMP) |> 
  summarise(mean(na.omit(LENGTH)), 
            sd(na.omit(LENGTH))) 

```

## Priors 
```{r priors-2}
model.re.formula <- bf(LENGTH ~ 1 + (1|LEVEL/TANK) + (1|POPULATION) + (1|FEMALE))
get_prior(model.re.formula, data=growth3)
growth.priors <- prior(normal(31.4, 1.5), class="Intercept") +  
  prior(student_t(3, 0, 4.4), class = "sigma")
```

## random factors
```{r fit-model-1, cache=TRUE} 

model.re <- brm(model.re.formula,
              data = growth3, 
              prior = growth.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
prior_summary(model.re) 
saveRDS(model.re, file="./01.growth_data_analysis_files/model.re.length.RDS")
```
## model validation [random factors]
```{r model-diag-1}
stan_trace(model.re$fit)
stan_ac(model.re$fit) 
stan_rhat(model.re$fit) 
stan_ess(model.re$fit)
stan_dens(model.re$fit, separate_chains = TRUE)
```

Model seems to perform well enough. There is one or two bars below the effective sample size cut off. But this will likely get smoothed out with more iterations and chains. Also it is very few samples. Lets start adding fixed factors. 

# Fit mode [fixed factors] {.tabset .tabset-pills}

Great lets start to fit our models. There are number of variables within our data frame some of which may or may not be important. To investigate which variables are important and which are not will test different hypotheses that use different combinations of variables that are suited to answer reasonable hypotheses.  

We will start modelling the standard length of juveniles.

First we will test 3 different hypotheses as described below in more detail. All hypotheses-testing models will have **LENGTH** as the response variable as well as **DEV_TEMP** and **DENSITY** as independent variables. Note that within these models there are no random variables, we will examine random variables in later steps.  

1. The first model will test that hypotheses that juvenile length at different developmental temperatures will also be heavily influenced by the length of the parents. Therefore, this model will include both **MALE_STANDARD_LENGTH** and **FEMALE_STANDARD_LENGTH**. However, it is important to note that the length of parents will like be related to each other (i.e., _collinearity_). We will confirm this assumption with some model validation descriptive statistics. This hypothesis can be seen as out _'basic'_ model.   

```{r hypothesis-1, echo=TRUE, eval=FALSE}
cLENGTH ~ DEV_TEMP + cFEMALE_STANDARD_LENGTH + cDENSITY + {random factors}
```

**NOTE:** Although not displayed this model will only include **FEMALE_STANDARD_LENGTH**, when both *MALE_* and *FEMALE_* standard length are included the model is very unhappy due to the collinearity between the two variables. 

2. The second model is based around the clutch/maternal conditions. Additional variables will include **FEMALE_STANDARD_LENGTH**, **DAYS_IN_TEMPERATURE** -applies to parents, **EGG_COUNT**, and **HATCHING_SUCCESS**. The idea of this hypothesis is that offspring length may be determined by early life conditions such as the size of the mother, how long the mother was exposed to potentially stressful conditions, how wide or narrow reproductive energy was spread, as well as the potential 'health' (as indicated by hatching success) of the clutch. 

```{r hypothesis-2, echo=TRUE, eval=FALSE}
cLENGTH ~ DEV_TEMP + cFEMALE_STANDARD_LENGTH + cDENSITY + DAYS_IN_TREATMENT + EGG_COUNT + HATCHING_SUCCESS + {random factors}
```

3. The last model is a geographic model and will include **FEMALE_STANDARD_LENGTH**, **FEMALE_LATITUDE**, **REGION** and **DENSITY**. In all but a few cases the farther and mother are from the same reef, therefore **FEMALE_LATITUDE** should be the same as **MALE_LATITUDE**. In the event that maternal and paternal sources were from different reefs, both parents would have come from similar latitudes. **POPULATION** was not included as it caused convergence issues, potentially due to the limited sample size from different populations. 

```{r hypothesis-3, echo=TRUE, eval=FALSE}
cLENGTH ~ DEV_TEMP*REGION + cFEMALE_STANDARD_LENGTH + cDENSITY + FEMALE_LAT + REGION + {random factors}
```

Once these models are run will be investigate their summary statistics to determine which factors were/were not deemed to have an impact on variation explained. Further models containing combinations of variables may also be explored depending on results.

Also because we are doing Bayesian modelling we will be listing priors. Our length data is normally distributed as shown in some of the exploratory data analysis plots. We can confirm this assumption during the model validation stage as well. Out starting priors will be uninformative priors with distribution of gaussian(0,1), this may or may not change as we progress. 

# Prior investigation 
```{r }
growth3 |> 
  group_by(REGION,DEV_TEMP) |> 
  summarise(mean(na.omit(LENGTH)), 
            sd(na.omit(LENGTH))) 

```

## Basic model

### Priors 
```{r priors-2}
model1.formula <- bf(LENGTH ~ DEV_TEMP*REGION + 
                      scale(FEMALE_STANDARD_LENGTH, center=TRUE, scale=TRUE) + 
                      scale(DENSITY, center=TRUE, scale=TRUE) + 
                      scale(AGE_DAYS, center=TRUE, scale=TRUE)+ 
                       (1|LEVEL/TANK) + (1|POPULATION) + (1|FEMALE),
              family=gaussian()) 
get_prior(model1.formula, data=growth3)
growth.priors <- prior(normal(31.4, 1.5), class="Intercept") + 
  prior(normal(0, 1.5), class="b") + 
  prior(student_t(3, 0, 4.4), class = "sigma")
```

### Basic model
```{r fit-model-1, cache=TRUE} 
model1 <- brm(model1.formula,
              data = growth3, 
              prior = growth.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
prior_summary(model1) 
saveRDS(model1, file="./01.growth_data_analysis_files/model1.length.RDS")
```
In this summary statistic table it tells us: 

* for the intercept, it is using a student t(flatter normal) prior with a mean of 0.1 and a standard deviation of 3.8. These values are derived from the median and median absolute deviation of the response variable 

### stan plots

```{r mcmc-diag-model1-2, fig.height=9}
stan_trace(model1$fit)
stan_ac(model1$fit) 
stan_rhat(model1$fit) 
stan_ess(model1$fit)
stan_dens(model1$fit, separate_chains = TRUE) 
```

## Maternal effects model 

### Priors 
```{r priors-2}
model.mat.formula <- bf(LENGTH ~ DEV_TEMP*REGION + 
                      scale(FEMALE_STANDARD_LENGTH, center=TRUE, scale=TRUE) + 
                      scale(DENSITY, center=TRUE, scale=TRUE) + 
                      scale(AGE_DAYS, center=TRUE, scale=TRUE)+ 
                      scale(DAYS_IN_TREATMENT, center=TRUE, scale=TRUE)+
                      scale(EGG_COUNT, center=TRUE, scale=TRUE)+
                       (1|LEVEL/TANK) + (1|POPULATION) + (1|FEMALE),
              family=gaussian()) 
get_prior(model1.formula, data=growth3)
growth.priors <- prior(normal(31.4, 1.5), class="Intercept") + 
  prior(normal(0, 1.5), class="b") + 
  prior(student_t(3, 0, 4.4), class = "sigma")
```

```{r fit-model-2, cache=TRUE}
model.mat <- brm(model.mat.formula,
              family=gaussian(),
              data = growth3, 
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
prior_summary(model.mat) 
saveRDS(model.mat.formula, file="./01.growth_data_analysis_files/model.maternal.length.RDS")
```


### stan plots
```{r mcmc-diag-model2-2, fig.height=9}
stan_trace(model.mat$fit)
stan_ac(model.mat$fit) 
stan_rhat(model.mat$fit) 
stan_ess(model.mat$fit)
stan_dens(model.mat$fit, separate_chains = TRUE)
```


## Geographic model 

### Priors 
```{r priors-geo}
model.geo.formula <- bf(LENGTH ~ DEV_TEMP*REGION + 
                      scale(FEMALE_STANDARD_LENGTH, center=TRUE, scale=TRUE) + 
                      scale(DENSITY, center=TRUE, scale=TRUE) + 
                      scale(AGE_DAYS, center=TRUE, scale=TRUE)+ 
                      scale(FEMALE_LAT, center=TRUE, scale=TRUE)+
                       (1|LEVEL/TANK) + (1|POPULATION) + (1|FEMALE),
              family=gaussian()) 
get_prior(model1.formula, data=growth3)
growth.priors <- prior(normal(31.4, 1.5), class="Intercept") + 
  prior(normal(0, 1.5), class="b") + 
  prior(student_t(3, 0, 4.4), class = "sigma")
```

```{r fit-model-3, cache=TRUE}
model.geo <- brm(model.geo.formula,
              data = growth3, 
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
prior_summary(model.geo) 
saveRDS(model.geo.formula, file="./01.growth_data_analysis_files/model.geographic.length.RDS")
```

### stan plots
```{r mcmc-diag-model3-2, fig.height=9}
stan_trace(model.geo$fit)
stan_ac(model.geo$fit) 
stan_rhat(model.geo$fit) 
stan_ess(model.geo$fit)
stan_dens(model.geo$fit, separate_chains = TRUE)
```

## {-}

# Model Comparisons 

All of our models performed relatively well. To determine which model we will use going forward we will compare the three models we ran against each other. Models will be compared via leave-one-out cross-validation, widely applicable information criterion (waic), and bayes factor. 

The **model.mat** model will not be included in the comparison because the additional covariates within the model did not seem to explain a suitable amount of varirance in the model, ALSO, because there were more _'NA's_ in the these added covariates the observation sizes within the models were different meaning the models cannot be compared against each other using standard model comparison tools. 

## Comparison methods {.tabset}


### LOO
```{r model-comparisons-2}
LOO(model1, model.geo) 
```


## {-}

All model comparison methods indicate that **model1** outperforms **model.geo**. Therefore we will proceed with **model1** 

# Model validation 

## DHARMa residuals 
```{r model-validation-2}
pp_check(model1, type = 'dens_overlay')

preds <- posterior_predict(model1, ndraws=250, summary=FALSE)
model1.resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = na.omit(growth3$LENGTH), 
                              fittedPredictedResponse = apply(preds, 2, median), 
                              integerResponse = 'student')
plot(model1.resids); testDispersion(model1.resids) 

```

I'm hesitant to remove further outliers. The mass of samples that sit above the main cluster don't appear to be random, but rather belong to sets of populations, making me think that these data points are not outliers, but rather may be part of a geniunine pattern. The data set is rather large meaning some diagnositics need to be careful in intrepreting. For example, the KS test is used to detect deviations from the assumed distribution within the model. With such a large sample size small deviations can cause significant differences. If we look at our pp_check plot we can see that our observation and modelled distribution are actually very similar.The DHARMa checks also should that there are still outliers within the dataset and is likely upset about the cluster of points above the main cluster, but as previously stated these data points may be genunine. Once again due to the size of the dataset, this test may be overly sensitive. By looking at the residuals there is no clear pattern despite the DHARMa checks raising an alarm. 


In the case with large datasets visual checks provide additional insight to statistical tests, and in this case out visual analysis seems to point in the direction of our model being appropriate. 

# Partial effects plots 

## conditional_effects 

```{r partial-plots-cond-eff-1}
model1 |> 
  conditional_effects(spaghetti = TRUE, ndraws=200) 
``` 

# Model investigation {.tabset}

## summary 

```{r summary-100}
summary(model1)
```

## R2 

```{r r-squared}
model1 |> bayes_R2(summary = FALSE) |> median_hdci()
```

## tidyMCMC 

```{r tidy}
tidyMCMC(model1, estimate.method='median', conf.int=TRUE, conf.method='HPDinterval')
```

## gather draws 

```{r gather_draws}
#model1 |> get_variables()
model1 |> gather_draws(`b_.*|sigma`, regex =TRUE) |> 
  median_hdci()
``` 

## bayesplot 

```{r bayesplot-1}
model1 |> mcmc_plot(type='intervals')
```

## emmeans - pariwise 

```{r emmeans-pairwise}
model1 |> emmeans(pairwise ~ REGION*DEV_TEMP, type="response") |> pairs(by="DEV_TEMP") |> summary()
```

## probabilities 
```{r probabilities}

```
# {-}

# summary figure 

```{r summary-figure-1}
var <- get_variables(model1)
var1 <- get_variables(model1)[c(1:4,8:9)] 

int_draws_spread <- model1 |> spread_draws(!!!syms(var1)) 

int_draws_spread2 <- int_draws_spread |> 
  gather_draws(b_Intercept, b_REGIONleading) |> 
  left_join(int_draws_spread, by = c(".chain",".iteration",".draw"))
  
  
int_draws <- int_draws_spread2 |> 
  mutate(x28.5 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value`, 
                               `.variable` != 'b_Intercept' ~ 
                                 `.value` + b_Intercept), 
         
         x30 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value` + b_DEV_TEMP30, 
                             `.variable` == 'b_REGIONleading' ~ 
                                 `.value` + b_Intercept + b_DEV_TEMP30 + `b_DEV_TEMP30:REGIONleading`), 
         
         x31.5 = case_when(`.variable` == 'b_Intercept' ~ 
                                 `.value` + b_DEV_TEMP31.5, 
                             `.variable` == 'b_REGIONleading' ~ 
                                 `.value` + b_Intercept + b_DEV_TEMP31.5 + `b_DEV_TEMP31.5:REGIONleading`))
  
int_draws_plotting <- int_draws |> 
  pivot_longer(cols = starts_with("x"), 
               names_to = "DEV_TEMP", 
               values_to = "LENGTH") |> 
  transmute(LATITUDE = case_when(`.variable` == "b_Intercept" ~ "Low latitude", 
                                 `.variable` == "b_REGIONleading" ~ "High latitude"), 
            DEV_TEMP = case_when(DEV_TEMP == 'x28.5' ~ 'DEV_TEMP_28.5', 
                                 DEV_TEMP == 'x30' ~ 'DEV_TEMP_30', 
                                 DEV_TEMP == 'x31.5' ~ 'DEV_TEMP_31.5'),
            LENGTH = LENGTH, 
            LATITUDE_B = LATITUDE, 
            DEV_TEMP_B = DEV_TEMP,
            chain = `.chain`, 
            iteration = `.iteration`, 
            draw_n = `.draw`) |> 
  unite("EXP_GROUP",LATITUDE_B, DEV_TEMP_B,sep="_") |> 
  mutate(EXP_GROUP = as.factor(EXP_GROUP)) |> 
  mutate(EXP_GROUP = factor(EXP_GROUP, levels=c("High latitude_DEV_TEMP_28.5","High latitude_DEV_TEMP_30", "High latitude_DEV_TEMP_31.5",
                                                "Low latitude_DEV_TEMP_28.5","Low latitude_DEV_TEMP_30", "Low latitude_DEV_TEMP_31.5")))


length.plot <- int_draws_plotting |> 
  ggplot(aes(x=EXP_GROUP, y=LENGTH)) + 
  geom_hline(yintercept = 31.32, linetype="dashed", linewidth=1, color="grey58", alpha=0.8) + 
  stat_halfeye(aes(fill = EXP_GROUP, fill_ramp = after_stat(level)), 
               point_interval = mode_hdci, 
               .width = c(.66, .90, .95)) + 
  scale_fill_ramp_discrete(na.translate=FALSE, 
                           labels =c("0.95","0.90","0.66"), 
                           name = "Credible interval") +
  scale_fill_manual(values = c("lightskyblue" ,"dodgerblue2", "dodgerblue4","coral", "red2","firebrick4"))+ 
  scale_y_continuous(limits=c(25,35), breaks = seq(25,35, 5))+
  ylab("CENTERED LENGTH (mm)") + xlab("EXPERIMENTAL GROUP") +
  scale_x_discrete(labels = c("Low latitude_DEV_TEMP_28.5" = paste0("Low latitude 28.5","\u00B0","C"), 
                              "Low latitude_DEV_TEMP_30" = paste0("Low latitude 30","\u00B0","C"),
                              "Low latitude_DEV_TEMP_31.5" = paste0("Low latitude 31.5","\u00B0","C"), 
                              "High latitude_DEV_TEMP_28.5" = paste0("High latitude 28.5","\u00B0","C"),
                              "High latitude_DEV_TEMP_30" = paste0("High latitude 30","\u00B0","C"),
                              "High latitude_DEV_TEMP_31.5" = paste0("High latitude 31.5","\u00B0","C"))) +
  annotate("text", x=6.8,y=32.4, label = paste0(round(mean(growth3$LENGTH), 2)," (mm)"), color="grey58") +
  coord_flip() + 
  theme_classic() + 
  guides(fill = "none") + 
  theme(legend.position = c(.18,.86), 
        axis.title.y = element_text(margin = margin(r =0.3, unit = "in"), size = 12), 
        axis.title.x = element_text(margin = margin(t = 0.3, unit="in"), size =12), 
        legend.key = element_rect(color="black", size=1.25)); length.plot
```

```{r eval=FALSE, echo=TRUE}
ggsave(file="./figures/length.plot.svg",  plot=length.plot, width=8, height=5, units = "in", dpi=300) 
ggsave(file="./figures/length.plot.pdf",  plot=length.plot, width=8, height=5, units = "in", dpi=300)
```


