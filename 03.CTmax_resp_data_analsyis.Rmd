---
title: "03. CTmax_analysis_resp_analysis"
author: "Elliott Schmidt"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true  
    toc_depth: 2
    toc_float: true
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: monochrome
    theme: cerulean
    latex_engine: xelatex
---

# Scenario 

Within this chapter developmental plasticity was explored within _Acanthochromis polyacanthus_ that were collected from two different regions (i.e., low-latitude, Cairns, and high-latitude, Mackay). Fish were held in common garden experiments at 28.5 C. Clutch data was collected along with parental morphometeric data to determine how fish from each population performed at 28.5 C, a temperature that was shown to produce similar absoluate aerobic scope performances in a previous study [link]. Once hatched offspring were placed into three different temperature treatments, 28.5, 30, and 31.5 C. After approximately 5-6 months offspring length and weight was measured, as well as CTmax and respiration during CTmax trials. 

# Load packages 

```{r load-packages-1, warning=FALSE, message=FALSE}
library(tidyverse) # data manipulation
library(ggpubr) # figure arrangement 
library(brms) # Bayesian models
library(StanHeaders)# needed to run Bayesian models
library(rstan) # needed to run Bayesian models
library(standist) # needs to be installed 
library(bayesplot) # needed for MCMC diagnostics 
library(DHARMa) # model validation 
library(ggdist) # partial plots 
library(tidybayes) # partial plots 
library(broom.mixed) # model investigation
library(emmeans) # pairwise comparisons
library(rstanarm) # pairwise comparisons - need for emmeans 
library(ggpubr) # arranging figures 
library(mgcv) # GAM 
library(modelr) # plotting
library(segmented)
```

# Set working directory 

```{r setwd-1, echo=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude")
``` 

```{r setwd-2, echo=TRUE, eval=FALSE}
knitr::opts_knit$set(root.dir=working.dir)
```

# Import data 

This data set has no point outliers however, in the next chunk 3 samples will be 
discarded due to poor data quailty 

```{r import-data-1, message=FALSE}
lat_resp_dat <- read_delim("C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude/import_files/lat_resp_dat_no_outliers.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(area = col_skip(), rate.a.spec = col_skip()), 
    trim_ws = TRUE)
```

# Data manipulation 

```{r data-manipulation-1}
rows_of_data <- count(lat_resp_dat, sampleID)
lat_resp_dat2 <- lat_resp_dat |> 
  mutate(dev.temp = as.factor(dev.temp), 
         replicate = str_sub(sampleID, -1,-1), 
         population = factor(population)) |>
                                           # number of observations = 5758
  filter(sampleID != "56.CARL.137.28,5.1", # 5777 - 76 = 5682
         sampleID != "56.CARL.137.28,5.2", # 5701 - 64 = 5618
         sampleID != "60.LCKM.152.30.1"  # 5637 - 76 = 5542
  ) |> 
  filter(time_lag_sec >2001) |> # remove samples from first 5 cycles (i.e., first 33 minutes) 
  group_by(sampleID) |> 
  mutate(max_value_index = which.max(rate.output), 
         row_number = row_number(), 
         max.rate = max(rate.output), 
         low.rate = mean(rate.output[order(rate.output)[1:10]]), 
         net.rate = max.rate - low.rate) |> 
  filter(row_number <= max_value_index) |>
  ungroup() |> 
  mutate(region = factor(region), 
         dev.temp =factor(dev.temp), 
         level = as.factor(case_when(tank >= 1 & tank <= 199 ~ 1,
                           tank >= 200 & tank <= 299 ~ 2,
                           tank >= 300 & tank <= 399 ~ 3,
                           TRUE ~ NA_real_)), 
         female = factor(female)) |> 
  unite("dev.temp.region",c(dev.temp,region), remove=FALSE) |> 
  mutate(dev.temp.region = factor(dev.temp.region))
```

```{r data-manipulation-2, eval=TRUE, echo=FALSE}
CTmax.values <- lat_resp_dat2 |> 
  group_by(sampleID) |> 
  slice(which.max(Temperature))
``` 

# Exploratory data analysis  {.tabset}

## 2nd order polynomial

```{r eda-1, warning=FALSE, message=FALSE, fig.height=24, fig.width=8}

eda1 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output)) + 
  geom_point(alpha=0.5, color = "black") + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE), color = "red") + 
  theme_classic() +
  ggtitle("All data points - 2nd order polynomial")

eda2 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=region)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE), color = "red") + 
  facet_wrap(~ region) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial")

eda3 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=dev.temp)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE)) + 
  facet_wrap(~ region) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial") 

eda4 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=region)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE)) + 
  facet_wrap(~ dev.temp) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial")

eda5 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=population)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE), color = "red") + 
  facet_wrap(~ population) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Population - 2nd order polynomial")

eda6 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=dev.temp)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE)) + 
  facet_wrap(~ population) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Population - 2nd order polynomial")

eda.fig <- ggarrange(eda1,eda2,eda3,eda4,eda5,eda6,
          nrow = 6, 
          ncol=1); eda.fig
```

## 3rd order polynomial

```{r eda-2, warning=FALSE, message=FALSE, fig.height=24, fig.width=8}

eda1 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output)) + 
  geom_point(alpha=0.5, color = "black") + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  theme_classic() +
  ggtitle("All data points - 2nd order polynomial")

eda2 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=region)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  facet_wrap(~ region) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial")

eda3 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=dev.temp)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 3, raw=TRUE)) + 
  facet_wrap(~ region) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial") 

eda4 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=region)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 3, raw=TRUE)) + 
  facet_wrap(~ dev.temp) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial")

eda5 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=population)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 3, raw=TRUE), color = "red") + 
  facet_wrap(~ population) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Population - 2nd order polynomial")

eda6 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=dev.temp)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 3, raw=TRUE)) + 
  facet_wrap(~ population) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Population - 2nd order polynomial")

eda.fig <- ggarrange(eda1,eda2,eda3,eda4,eda5,eda6,
          nrow = 6, 
          ncol=1); eda.fig
```

# Fit model [random factors] {.tabset}


First we will place random factors only within out model and see if they do a good job explaining the variance within our model. We will also be include priors which will be based off of out length data. 

Hypothesis test will include:

0. Null model
1. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK)
2. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK) + (1| LEVEL)
3. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK) + (1| LEVEL) + (1| POPULATION)
4. EGG_COUNT ~ 1 + (1| FEMALE) + (1| TANK) + (1| LEVEL) + (1| POPULATION)+ (1| CLUTCH_ORDER)

```{r}
lat_resp_dat2 |> 
  group_by(region,dev.temp) |> 
  summarise(mean(na.omit(rate.output)), 
            sd(na.omit(rate.output))) 
```

## Priors 
```{r prior-investigation-random-factors}
rate.priors <- prior(normal(430, 0.25), class="Intercept") +  
  prior(student_t(3, 0, 195), class = "sigma")
```

## Models {.tabset}

### Null 
```{r null, cache=TRUE}
f.model.null <- bf(rate.output ~ 1, 
                   family = gaussian()) 

model.null <- brm(f.model.null,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model.null, file="./03.CTmax_resp_data_analsyis_files/model.null.RDS")
```


### Model1
```{r fit-model1, cache=TRUE} 
f.model1 <- bf(rate.output ~ 1 + (1| female) + (1| tank), 
                          family=gaussian())

model1 <- brm(f.model1,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1, file="./03.CTmax_resp_data_analsyis_files/model1.RDS")
```

### Model2
```{r fit-model2, cache=TRUE} 
f.model2 <- bf(rate.output ~ 1 + (1| female) + (1| tank) + (1| level), 
                          family=gaussian())

model2 <- brm(f.model2,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model2, file="./03.CTmax_resp_data_analsyis_files/model2.RDS")
```

### Model3
```{r fit-model3, cache=TRUE}  
f.model3 <- bf(rate.output ~ 1 + (1| female) + (1| tank) + (1| level) + (1| population), 
               family=gaussian())

model3 <- brm(f.model3,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model3, file="./03.CTmax_resp_data_analsyis_files/model3.RDS")
```

### Model4
```{r fit-model4, cache=TRUE} 
f.model4 <- bf(rate.output ~ 1 + (1| female) + (1 | tank) + (1| level) + (1| population)+ (1| clutch_order), 
                        family=gaussian())

model4 <- brm(f.model4,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE),  
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model4, file="./03.CTmax_resp_data_analsyis_files/model4.RDS")
```

### {-}

## LOO
```{r model-comparisons-2}
LOO(model.null,model1, model2,model3,model4) 
```

## {-}

# Fit model [fixed factors - polynomials] {.tabset} 

## Prior investigation 
```{r }
lat_resp_dat2 |> 
  group_by(region,dev.temp) |> 
  summarise(mean(na.omit(rate.output)), 
            sd(na.omit(rate.output))) 
```

## Priors
```{r }
rate.priors <- prior(normal(430, 0.25), class="Intercept") + 
  prior(normal(0, 40), class="b")
  prior(student_t(3, 0, 195), class = "sigma")
```

## Models {.tabset}

### Model1.p1 {.tabset}

#### Model1.p1

```{r model1.p1, cache=TRUE}
f.model1.p1 <- bf(rate.output ~ 1 + 
                         dev.temp*region + Temperature +
                         scale(mass, center=TRUE, scale=TRUE) + 
                         (1| female) + (1| tank) , 
                         family=gaussian()) 

model1.p1 <- brm(f.model1.p1,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1.p1, file="./03.CTmax_resp_data_analsyis_files/model1.p1.RDS")
```

#### DHARMa
```{r model1.p1-DHARMa}
#--- distribution check ---#
pp_check(model1.p1, type = 'dens_overlay_grouped', ndraws=150, group="region")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.p1, ndraws=250, summary=FALSE)
model1.p1_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = lat_resp_dat2$rate.output, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.p1_resids) ; testDispersion(model1.p1_resids)
```

#### MCMC diagnostics
```{r model1.p1-mcmc-diag, fig.height=9}
stan_trace(model1.p1$fit)
stan_ac(model1.p1$fit) 
stan_rhat(model1.p1$fit) 
stan_ess(model1.p1$fit)
stan_dens(model1.p1$fit, separate_chains = TRUE)
```

#### {-}

### model1.p2 {.tabset}

#### model1.p2

```{r model1.p2, cache=TRUE}
f.model1.p2 <- bf(rate.output ~ 1 + 
                         dev.temp*region + poly(Temperature, 2) +
                         scale(mass, center=TRUE, scale=TRUE) + 
                         (1| female) + (1| tank) , 
                         family=gaussian()) 

model1.p2 <- brm(f.model1.p2,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1.p2, file="./03.CTmax_resp_data_analsyis_files/model1.p2.RDS")
```

#### DHARMa
```{r model1.p2-DHARMa}
#--- distribution check ---#
pp_check(model1.p2, type = 'dens_overlay_grouped', ndraws=150, group="region")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.p2, ndraws=250, summary=FALSE)
model1.p2_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = lat_resp_dat2$rate.output, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.p2_resids) ; testDispersion(model1.p2_resids)
```

#### MCMC diagnostics
```{r model1.p2-mcmc-diag, fig.height=9}
stan_trace(model1.p2$fit)
stan_ac(model1.p2$fit) 
stan_rhat(model1.p2$fit) 
stan_ess(model1.p2$fit)
stan_dens(model1.p2$fit, separate_chains = TRUE)
``` 

#### {-}  

### model1.p3 {.tabset}

#### model1.p3

```{r model1.p3, cache=TRUE}
f.model1.p3 <- bf(rate.output ~ 1 + 
                         dev.temp*region + poly(Temperature, 3) +
                         scale(mass, center=TRUE, scale=TRUE) + 
                         (1| female) + (1| tank) , 
                         family=gaussian()) 

model1.p3 <- brm(f.model1.p3,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1.p3, file="./03.CTmax_resp_data_analsyis_files/model1.p3.RDS")
```

#### DHARMa
```{r model1.p3-DHARMa}
#--- distribution check ---#
pp_check(model1.p3, type = 'dens_overlay_grouped', ndraws=150, group="region")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.p3, ndraws=250, summary=FALSE)
model1.p3_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = lat_resp_dat2$rate.output, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.p3_resids) ; testDispersion(model1.p3_resids)
```

#### MCMC diagnostics
```{r model1.p3-mcmc-diag, fig.height=9}
stan_trace(model1.p3$fit)
stan_ac(model1.p3$fit) 
stan_rhat(model1.p3$fit) 
stan_ess(model1.p3$fit)
stan_dens(model1.p3$fit, separate_chains = TRUE)
``` 

#### {-}

### LOO 
```{r model-comparisons-polynomial}
LOO(model1.p1, model1.p2,model1.p3) 
```

### {-}

# Fit model [fixed factors - GAM] {.tabset} 

## GAM model k=4 {.tabset}  
### GAM model k=4
```{r GAMK4, cache=TRUE} 

f.model1.gamk4 <- bf(rate.output ~ 1 + 
                         t2(dev.temp,region,Temperature, k=4, bs="fs", by=dev.temp.region) + 
                         scale(mass, center=TRUE, scale=TRUE) + 
                         (1| female) + (1| tank), 
                         family=gaussian()) 

model1.gamk4 <- brm(f.model1.gamk4,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1.gamk4, file="./03.CTmax_resp_data_analsyis_files/model1.gamk4.RDS")
```

### DHARMa
```{r GAMK4-DHARMa}
#--- distribution check ---#
pp_check(model1.gamk4, type = 'dens_overlay_grouped', ndraws=150, group="dev.temp.region")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.gamk4, ndraws=250, summary=FALSE)
model1.gamk4_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = lat_resp_dat2$rate.output, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.gamk4_resids) ; testDispersion(model1.gamk4_resids)
```

### MCMC diagnostics
```{r GAMK4-mcmc-diag, fig.height=9}
stan_trace(model1.gamk4$fit)
stan_ac(model1.gamk4$fit) 
stan_rhat(model1.gamk4$fit) 
stan_ess(model1.gamk4$fit)
stan_dens(model1.gamk4$fit, separate_chains = TRUE)
```
### {-}

## GAM model k=3 {.tabset}  
### GAM model k=3
```{r GAMK3, cache=TRUE}
f.model1.gamk3 <- bf(rate.output ~ 1 + 
                         t2(dev.temp,region,Temperature, k=3, bs="fs", by=dev.temp.region) + 
                         scale(mass, center=TRUE, scale=TRUE) + 
                         (1| female) + (1| tank), 
                         family=gaussian()) 

model1.gamk3 <- brm(f.model1.gamk3,
              data = lat_resp_dat2, 
              prior = rate.priors,
              warmup = 500, 
              iter = 5000,
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              sample_prior = "yes",
              chains = 2, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 
saveRDS(model1.gamk3, file="./03.CTmax_resp_data_analsyis_files/model1.gamk3.RDS")
```

### DHARMa
```{r GAMK3-DHARMa}
#--- distribution check ---#
pp_check(model1.gamk3, type = 'dens_overlay_grouped', ndraws=150, group="region")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.gamk3, ndraws=250, summary=FALSE)
model1.gamk3_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = lat_resp_dat2$rate.output, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.gamk3_resids) ; testDispersion(model1.gamk3_resids)
```

### MCMC diagnostics
```{r GAMK3-mcmc-diag, fig.height=9}
stan_trace(model1.gamk3$fit)
stan_ac(model1.gamk3$fit) 
stan_rhat(model1.gamk3$fit) 
stan_ess(model1.gamk3$fit)
stan_dens(model1.gamk3$fit, separate_chains = TRUE)
```
### {-}

```{r}
AIC(model1.gamk3, model1.gamk4)
```

## {-}

# Partial effects plots 

## conditional_effects 

```{r partial-plots-cond-eff-1}
model1.gamk4 |> 
  conditional_effects(spaghetti = TRUE, ndraws=200) 
``` 

# Model investigation {.tabset}

## summary 

```{r summary-100}
summary(model1.gamk4)
#car::Anova(model1.geo.gamma)
```

## R2 

```{r r-squared}
model1.gamk4 |> bayes_R2(summary = FALSE) |> median_hdci()
```

## tidyMCMC 

```{r tidy}
tidyMCMC(model1.gamk4, estimate.method='median', conf.int=TRUE, conf.method='HPDinterval')
```

## gather draws 

```{r gather_draws}
#model1.re.wo |> get_variables()
model1.gamk4 |> gather_draws(`b_.*|sigma`, regex =TRUE) |> 
  median_hdci()
``` 

## bayesplot 

```{r bayesplot-1}
model1.gamk4 |> mcmc_plot(type='intervals')
```

## emmeans - pariwise 

```{r emmeans-pairwise}
model1.gamk4 |> emmeans(pairwise ~ region*dev.temp, type="response") |> pairs(by="dev.temp") |> summary(infer=TRUE)

model1.gamk4 |> emmeans(pairwise ~ region*dev.temp, type="response") |> pairs(by="region") |> confint()

model1.gamk4 |> emmeans(pairwise ~ region*dev.temp, type="response") |> regrid() 

model1.gamk4 |> emmeans(pairwise ~ region*dev.temp, type="response") |> pairs(by="region") |> confint()
```

## emtrenns - pariwise 

```{r emtrends-pairwise}
emtrends(model1.gamk4, specs=pairwise~dev.temp*region, var = "Temperature")  

```

## probabilities 
```{r probabilities}
mtsqst <- model1.gamk4 |> emmeans(pairwise ~ region*dev.temp)
mtsqrt2 <- mtsqst$contrasts |> gather_emmeans_draws()
mtsqrt2 %>% group_by(contrast) %>% dplyr::summarise(Prob = sum(.value>0)/n())
```

# summary figure 

```{r summary-figure-1, warning=FALSE, message=FALSE}
resp.plot <- lat_resp_dat2 |> 
  group_by(region, dev.temp,dev.temp.region) |> 
  data_grid(Temperature=seq(from=min(lat_resp_dat2$Temperature), 
                          to=max(lat_resp_dat2$Temperature), 
                          length.out=100), 
            mass=0.00148299) |> 
  add_fitted_draws(model1.gamk4, 
                   n=300, 
                   re_formula=NA) |>  
  unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  ggplot(aes(x=Temperature, color=exp_group)) + 
  geom_line(aes(y=.value, group=paste(exp_group, .draw)), alpha=0.05) + 
  geom_smooth(aes(y=.value, color=exp_group), se=FALSE, size=1.5) + 
  theme_classic() + 
  facet_wrap(~dev.temp); resp.plot
```


```{r summary-figure-2, warning=FALSE, message=FALSE}
resp.plot2 <- lat_resp_dat2 |> 
  group_by(region, dev.temp,dev.temp.region) |> 
  data_grid(Temperature=seq(from=min(lat_resp_dat2$Temperature), 
                          to=max(lat_resp_dat2$Temperature), 
                          length.out=100), 
            mass=0.00148299) |> 
  add_fitted_draws(model1.gamk4, 
                   n=300, 
                   re_formula=NA) |>  
  unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  ggplot(aes(x=Temperature, color=exp_group)) + 
  geom_line(aes(y=.value, group=paste(exp_group, .draw)), alpha=0.05) + 
  geom_smooth(aes(y=.value, color=exp_group), se=FALSE, size=1.5) + 
  theme_classic() + 
  facet_wrap(~region); resp.plot2
```

```{r summary-figure-3, warning=FALSE, message=FALSE}
resp.plot3 <- lat_resp_dat2 |> 
  group_by(region, dev.temp,dev.temp.region) |> 
  data_grid(Temperature=seq(from=min(lat_resp_dat2$Temperature), 
                          to=max(lat_resp_dat2$Temperature), 
                          length.out=100), 
            mass=0.00148299) |> 
  add_fitted_draws(model1.gamk4, 
                   n=300, 
                   re_formula=NA) |>  
  unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  ggplot(aes(x=Temperature, color=exp_group)) + 
  geom_line(aes(y=.value, group=paste(exp_group, .draw)), alpha=0.05) + 
  geom_smooth(aes(y=.value, color=exp_group), se=FALSE, size=1.5) + 
  theme_classic(); resp.plot3
```

# Line segment analysis 
```{r line-segment-analysis}
summary(model1.gamk4)

model1.gamk4 |> conditional_smooths(smooths = 't2(dev.temp,region,Temperature,k=4,bs="fs",by=dev.temp.region)')

smooths <- posterior_predict(model1.gamk4, newdata = lat_resp_dat2, nsamples = 1000) 
first_derivative <- diff(smooths, difference =1)
second_derivative <- diff(smooths, difference =2)
inflection_points <- apply(sign(second_derivative), 2, function(x) which(diff(x) != 0)) 
inflection_points

newdata <- expand.grid(region = lat_resp_dat2$region,
                       dev.temp = lat_resp_dat2$dev.temp,
                       Temperature = seq(min(lat_resp_dat2$Temperature), max(lat_resp_dat2$Temperature), length.out = 10),
                       group = levels(lat_resp_dat2$dev.temp.region)) 

```

### piecewise linear regression 
```{r}
delete <- lat_resp_dat2 |> 
  group_by(region, dev.temp,dev.temp.region) |> 
  data_grid(Temperature=seq(from=min(lat_resp_dat2$Temperature), 
                          to=max(lat_resp_dat2$Temperature), 
                          length.out=100), 
            mass=0.00148299) |> 
  add_fitted_draws(model1.gamk4, 
                   n=300, 
                   re_formula=NA) |>  
  unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  filter(dev.temp.region == "28_leading")  

spline_fit <- smooth.spline(delete$Temperature, delete$.value, nknots = 4)

ggplot(delete, aes(x=Temperature, y=.value)) + 
  geom_point(color="black", alpha=0.05, size=1) + 
  geom_smooth(data=as.data.frame(spline_fit$data), aes(x=x, y=y, 
                                        color="red"), 
              size=2) 

 

my.lm <- lm(data=data, y ~ x) 
my.seg <- segmented(my.lm, 
                    seg.Z = ~x, 
                    psi=list(x=c(31,36)))
summary(my.seg) 

my.seg$psi 
slope(my.seg)

my.fitted <- fitted(my.seg)
my.model <- data.frame(temperature = data$x, rate.output= my.fitted)

ggplot(my.model, aes(x=temperature, y=rate.output)) + geom_line()

ggplot(delete, aes(x=Temperature, y=.value)) + 
  geom_point(color="black", alpha=0.05, size=1) + 
  geom_smooth(data=as.data.frame(spline_fit$data), aes(x=x, y=y, 
                                        color="red"), 
              size=2) + 
  geom_vline(xintercept = 34.34)
```
### piecewise linear regression 
```{r}
delete <- lat_resp_dat2 |> 
  group_by(region, dev.temp,dev.temp.region) |> 
  data_grid(Temperature=seq(from=min(lat_resp_dat2$Temperature), 
                          to=max(lat_resp_dat2$Temperature), 
                          length.out=100), 
            mass=0.00148299) |> 
  add_fitted_draws(model1.gamk4, 
                   n=300, 
                   re_formula=NA) |>  
  unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  filter(dev.temp.region == "31_core")  

spline_fit <- smooth.spline(delete$Temperature, delete$.value, nknots = 4) 

ggplot(delete, aes(x=Temperature, y=.value)) + 
  geom_point(color="black", alpha=0.05, size=1) + 
  geom_smooth(data=as.data.frame(spline_fit$data), aes(x=x, y=y, 
                                        color="red"), 
              size=2) 

data <- as.data.frame(x= spline_fit$x) |> 
  mutate(y = spline_fit$y)|> 
  rename(x = `spline_fit$x`)


my.lm <- lm(data=data, y ~ x) 
my.seg <- segmented(my.lm, 
                    seg.Z = ~x, 
                    psi=list(x=c(31,36.5)))
summary(my.seg) 

my.seg$psi 
slope(my.seg)

my.fitted <- fitted(my.seg)
my.model <- data.frame(temperature = data$x, rate.output= my.fitted)

ggplot(my.model, aes(x=temperature, y=rate.output)) + geom_line()

ggplot(delete, aes(x=Temperature, y=.value)) + 
  geom_point(color="black", alpha=0.05, size=1) + 
  geom_smooth(data=as.data.frame(spline_fit$data), aes(x=x, y=y, 
                                        color="red"), 
              size=2) + 
  geom_vline(xintercept = my.seg$psi[1,2]); ggplot(my.model, aes(x=temperature, y=rate.output)) + geom_line()
```


### piecewise linear regression 
```{r}
delete2 <- lat_resp_dat2 |> 
  group_by(region, dev.temp,dev.temp.region) |> 
  data_grid(Temperature=seq(from=min(lat_resp_dat2$Temperature), 
                          to=max(lat_resp_dat2$Temperature), 
                          length.out=100), 
            mass=0.00148299) |> 
  add_fitted_draws(model1.gamk4, 
                   n=300, 
                   re_formula=NA) |>  
  unite("exp_group", c("region","dev.temp"), remove=FALSE) |> 
  filter(dev.temp.region == "28_core")  

spline_fit <- smooth.spline(delete$Temperature, delete$.value, nknots = 4) 

ggplot(delete, aes(x=Temperature, y=.value)) + 
  geom_point(color="black", alpha=0.05, size=1) + 
  geom_smooth(data=as.data.frame(spline_fit$data), aes(x=x, y=y, 
                                        color="red"), 
              size=2) 

data <- as.data.frame(x= spline_fit$x) |> 
  mutate(y = spline_fit$y)|> 
  rename(x = `spline_fit$x`)


my.lm <- lm(data=data, y ~ x) 
my.seg <- segmented(my.lm, 
                    seg.Z = ~x, 
                    psi=list(x=c(31,36.5)))
summary(my.seg) 

my.seg$psi 
slope(my.seg)

my.fitted <- fitted(my.seg)
my.model <- data.frame(temperature = data$x, rate.output= my.fitted)

ggplot(my.model, aes(x=temperature, y=rate.output)) + geom_line()

ggplot(delete, aes(x=Temperature, y=.value)) + 
  geom_point(color="black", alpha=0.05, size=1) + 
  geom_smooth(data=as.data.frame(spline_fit$data), aes(x=x, y=y, 
                                        color="red"), 
              size=2) + 
  geom_vline(xintercept = my.seg$psi[1,2]); ggplot(my.model, aes(x=temperature, y=rate.output)) + geom_line()
```