---
title: "03.CTmax_analysis"
author: "Elliott Schmidt"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true  
    toc_depth: 2
    toc_float: true
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: monochrome
    theme: cerulean
    latex_engine: xelatex
---

# Scenario 

Within this chapter developmental plasticity was explored within _Acanthochromis polyacanthus_ that were collected from two different regions (i.e., low-latitude, Cairns, and high-latitude, Mackay). Fish were held in common garden experiments at 28.5 C. Clutch data was collected along with parental morphometeric data to determine how fish from each population performed at 28.5 C, a temperature that was shown to produce similar absoluate aerobic scope performances in a previous study [link]. Once hatched offspring were placed into three different temperature treatments, 28.5, 30, and 31.5 C. After approximately 5-6 months offspring length and weight was measured, as well as CTmax and respiration during CTmax trials. 

# Load packages 

```{r load-packages-1, warning=FALSE, message=FALSE}
library(tidyverse) # data manipulation
library(ggpubr) # figure arrangement 
library(brms) # Bayesian models
library(StanHeaders)# needed to run Bayesian models
library(rstan) # needed to run Bayesian models
library(standist) # needs to be installed 
library(bayesplot) # needed for MCMC diagnostics 
library(DHARMa) # model validation 
library(ggdist) # partial plots 
library(tidybayes) # partial plots 
library(broom.mixed) # model investigation
library(emmeans) # pairwise comparisons
library(rstanarm) # pairwise comparisons - need for emmeans 
library(ggpubr) # arranging figures
```

# Set working directory 

```{r setwd-1, echo=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude")
``` 

```{r setwd-2, echo=TRUE, eval=FALSE}
knitr::opts_knit$set(root.dir=working.dir)
```

# Import data 

This data set has no point outliers however, in the next chunk 3 samples will be 
discarded due to poor data quailty 

```{r import-data-1, message=FALSE}
lat_resp_dat <- read_delim("C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude/import_files/lat_resp_dat_no_outliers.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(area = col_skip(), rate.a.spec = col_skip()), 
    trim_ws = TRUE)
```

# Data manipulation 

```{r data-manipulation-1}
rows_of_data <- count(lat_resp_dat, sampleID)
lat_resp_dat2 <- lat_resp_dat |> 
  mutate(dev.temp = as.factor(dev.temp), 
         replicate = str_sub(sampleID, -1,-1), 
         population = factor(population)) |>
                                           # number of observations = 5758
  filter(sampleID != "56.CARL.137.28,5.1", # 5777 - 76 = 5682
         sampleID != "56.CARL.137.28,5.2", # 5701 - 64 = 5618
         sampleID != "60.LCKM.152.30.1"  # 5637 - 76 = 5542
  ) |> 
  filter(time_lag_sec >2001) |> # remove samples from first 5 cycles (i.e., first 33 minutes) 
  group_by(sampleID) |> 
  mutate(max_value_index = which.max(rate.output), 
         row_number = row_number(), 
         max.rate = max(rate.output), 
         low.rate = mean(rate.output[order(rate.output)[1:10]]), 
         net.rate = max.rate - low.rate) |> 
  filter(row_number <= max_value_index) |>
  ungroup() |> 
  mutate(cMASS = scale(mass, center=TRUE, scale=FALSE)[,1], 
         cAge = scale(age, center=TRUE, scale=FALSE)[,1], 
         region = factor(region), 
         dev.temp =factor(dev.temp), 
         LEVEL = as.factor(case_when(tank >= 1 & tank <= 199 ~ 1,
                           tank >= 200 & tank <= 299 ~ 2,
                           tank >= 300 & tank <= 399 ~ 3,
                           TRUE ~ NA_real_)), 
         female = factor(female))
```

```{r data-manipulation-2, eval=TRUE, echo=FALSE}
CTmax.values <- lat_resp_dat2 |> 
  group_by(sampleID) |> 
  slice(which.max(Temperature))
``` 

# Exploratory data analysis 

```{r eda-1, warning=FALSE, message=FALSE, fig.height=24, fig.width=8}

eda1 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output)) + 
  geom_point(alpha=0.5, color = "black") + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE), color = "red") + 
  theme_classic() +
  ggtitle("All data points - 2nd order polynomial")

eda2 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=region)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE), color = "red") + 
  facet_wrap(~ region) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial")

eda3 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=dev.temp)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE)) + 
  facet_wrap(~ region) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial") 

eda4 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=region)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE)) + 
  facet_wrap(~ dev.temp) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Region - 2nd order polynomial")

eda5 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=population)) + 
  geom_point(alpha=0.5) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE), color = "red") + 
  facet_wrap(~ population) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Population - 2nd order polynomial")

eda6 <- ggplot(lat_resp_dat2, aes(x=Temperature, y=rate.output, color=dev.temp)) + 
  geom_point(alpha=0.1) + 
  geom_smooth(method="lm", 
              se=TRUE, 
              fill=NA,
              formula = y~poly(x, 2, raw=TRUE)) + 
  facet_wrap(~ population) + theme_classic() +
  theme(legend.position = "none") +
  ggtitle("Population - 2nd order polynomial")

eda.fig <- ggarrange(eda1,eda2,eda3,eda4,eda5,eda6,
          nrow = 6, 
          ncol=1); eda.fig
```

# Fit model [random factors]

First we will place random factors only within out model and see if they do a good job explaining the variance within our model. We will also be include piors which will be based off of out length data.

## Prior investigation 
```{r }
lat_resp_dat2 |> 
  group_by(REGION,DEV_TEMP) |> 
  summarise(mean(na.omit(MASS)), 
            sd(na.omit(MASS))) 

``` 

# Model fit {.tabset}

Great lets start to fit our models. There are number of variables within our data frame some of which may or may not be important. To investigate which variables are important and which are not will test different hypotheses that use different combinations of variables that are suited to answer reasonable hypotheses. 

From out exploratory data analysis we can see that due to the upwards infliction within the data as fish approach CTmax we will likely need to apply a second order polynomial function to out temperature covariate. Due to the large sample size we have we will also explore how will General Additive Models can be used to model our data. 

We will start out by testing two different hypotheses. 

1. The first hypothesis that will be tested will be the base model that includes covariates that are essential to the question we are asking, are there regional differences in developmental plasticity within _Acanthchormis polyacanthus_ juveniles? To answer this question we will include a three-way interaction including **region** * **dev.temp** * **Temperature**, as well as the covariate **cMASS**, that stands for centered mass values, because we know that mass influences oxygen uptake. 

```{r model1-definition, eval=FALSE, echo=TRUE}
rate.output2 ~ region*dev.temp*poly(Temperature, 2) + cMASS
``` 

2. The second hypothesis will be similar to the base model but will include covariates that are associated with the systems that fish were tested on. Covariates will include **chamber** and **system**. By exploring this model we can make sure that the position that chambers were placed in the tanks did not influence oxygen consumption and that the two seems used, labelled DELL and ASUS from the computers that were used to collect data, produced comparable data. 

```{r model.equip-definition, eval=FALSE, echo=TRUE}
rate.output2 ~ region*dev.temp*poly(Temperature, 2) + cMASS + chamber + system
``` 

## Base model 

```{r base model, cache=TRUE}
model1 <- brm(rate.output2 ~ region*dev.temp*poly(Temperature, 2) + cMASS, 
              family=gaussian(), 
              data=lat_resp_dat2, 
              warmup = 4000, 
              iter=10000, 
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              chains=4, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 

``` 

### Model 1- sampling diagnositics {.tabset}

#### bayesplot 

```{r mcmc-diag-model1, fig.height=9}
mcmc_plot(model1, type='combo')
mcmc_plot(model1, type='trace') 
mcmc_plot(model1, type='dens_overlay') 
mcmc_plot(model1, type='acf_bar')
mcmc_plot(model1, type='rhat_hist')
mcmc_plot(model1, type='neff_hist') 
```

#### stan plots 

```{r stan-diag-model1, fig.height=9}
stan_trace(model1$fit)
stan_ac(model1$fit) 
stan_rhat(model1$fit) 
stan_ess(model1$fit)
stan_dens(model1$fit, separate_chains = TRUE)
```

### {-}

## Equipment model 

```{r equip-model1, cahce=TRUE}
model.equip <- brm(rate.output2 ~ region*dev.temp*poly(Temperature, 2) + cMASS + system + chamber, 
                   family=gaussian(), 
              data=lat_resp_dat2, 
              warmup = 4000, 
              iter=10000, 
              seed=123, 
              cores=2, 
              save_pars = save_pars(all=TRUE), 
              chains=4, 
              thin = 5, 
              control = list(adapt_delta=0.95))
```


### Equipment model - sampling diagnositics {.tabset}

#### bayesplot 

```{r mcmc-diag-model-equip, fig.height=9}
mcmc_plot(model.equip, type='combo')
mcmc_plot(model.equip, type='trace') 
mcmc_plot(model.equip, type='dens_overlay') 
mcmc_plot(model.equip, type='acf_bar')
mcmc_plot(model.equip, type='rhat_hist')
mcmc_plot(model.equip, type='neff_hist') 
```

#### stan plots 

```{r stan-diag-model-equip, fig.height=9}
stan_trace(model.equip$fit)
stan_ac(model.equip$fit) 
stan_rhat(model.equip$fit) 
stan_ess(model.equip$fit)
stan_dens(model.equip$fit, separate_chains = TRUE)
```

### {-}

## {-}

# Model compairisons {.tabset}

## WAIC
```{r model-comparisons-1}
model1.waic <- waic(model1)
model.equip.waic <- waic(model.equip) 
loo_compare(model1.waic, model.equip.waic) 
```  

## LOO 
```{r model-comparisons-2}
LOO(model1, model.equip) 
```
## {-}

It seems like additional information of chamber and system do not produce a more informative model

# {-}

# Randomn effects 

Before we validate the model we will include out random effects: 

1. **LEVEL**: What level the tank the clutch was held in, 1,2, or 3. 
2. **FEMALE**: To account for the factor that some clutches came from the same breeding pair

```{r random-effects, cache=TRUE}
findpriors = get_prior(rate.output2 ~ region*dev.temp*poly(Temperature, 2) + cMASS + (1|LEVEL) + (1|female), 
              family=gaussian(), 
              data=lat_resp_dat2); findpriors
priors = c(set_prior("normal(0,100)", class="b", coef="cMASS"), 
           set_prior("normal(0,100)", class="b", coef="dev.temp30"),
           set_prior("normal(0,100)", class="b", coef="dev.temp30:polyTemperature21"),
           set_prior("normal(0,100)", class="b", coef="dev.temp30:polyTemperature22"),
           set_prior("normal(0,100)", class="b", coef="dev.temp31"),
           set_prior("normal(0,100)", class="b", coef="dev.temp31:polyTemperature21"),
           set_prior("normal(0,100)", class="b", coef="dev.temp31:polyTemperature22"),
           set_prior("normal(0,100)", class="b", coef="polyTemperature21"),
           set_prior("normal(0,100)", class="b", coef="polyTemperature22"),
           set_prior("normal(0,100)", class="b", coef="regionleading"),
           set_prior("normal(0,100)", class="b", coef="regionleading:dev.temp30"),
           set_prior("normal(0,100)", class="b", coef="regionleading:dev.temp30:polyTemperature21"),
           set_prior("normal(0,100)", class="b", coef="regionleading:dev.temp30:polyTemperature22"),
           set_prior("normal(0,100)", class="b", coef="regionleading:dev.temp31"),
           set_prior("normal(0,100)", class="b", coef="regionleading:dev.temp31:polyTemperature21"),
           set_prior("normal(0,100)", class="b", coef="regionleading:dev.temp31:polyTemperature22"),
           set_prior("normal(0,100)", class="b", coef="regionleading:polyTemperature21"),
           set_prior("normal(0,100)", class="b", coef="regionleading:polyTemperature22")
           )
model1.re <- brm(rate.output2 ~ region*dev.temp*poly(Temperature, 2) + cMASS + (1|LEVEL) + (1|female), 
              family=gaussian(), 
              prior = priors,
              data=lat_resp_dat2, 
              warmup = 1500, 
              iter=4000, 
              seed=123, 
              cores=4, 
              save_pars = save_pars(all=TRUE), 
              chains=3, 
              thin = 5, 
              control = list(adapt_delta=0.95)) 

```
# Model validation {.tabset}

We will continue with the first model. lets start validating the model to see how it performed. The initial diagnostics seemed to be pretty good. Now lets check to see if it is violating any assumptions. 

## Distribution 

```{r model-validation}
pp_check(model1.re, type = 'dens_overlay')
```

## DHARMa residuals

```{r model-validation2}
preds <- posterior_predict(model1.re, ndraws=250, summary=FALSE)
model1.re.resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = na.omit(lat_resp_dat2$rate.output2), 
                              fittedPredictedResponse = apply(preds, 2, median), 
                              integerResponse = 'student')
plot(model1.re.resids) 
```

# {-}

## conditional_effects 

```{r partial-plots-cond-eff-1}
model1.re |> 
  conditional_effects(spaghetti = TRUE, ndraws=200) 
``` 

# Model investigation {.tabset}

## summary 

```{r summary-100}
summary(model1.re)
```

## R2 

```{r r-squared}
model1.re |> bayes_R2(summary = FALSE) |> median_hdci()
```

## tidyMCMC 

```{r tidy}
tidyMCMC(model1.re, estimate.method='median', conf.int=TRUE, conf.method='HPDinterval')
```

## gather draws 

```{r gather_draws}
#model1.re.wo |> get_variables()
model1.re |> gather_draws(`b_.*|sigma`, regex =TRUE) |> 
  median_hdci()
``` 

## bayesplot 

```{r bayesplot-1}
model1.re |> mcmc_plot(type='intervals')
```

## emmeans - pariwise 

```{r emmeans-pairwise}
model1.re |> emmeans(pairwise ~ region*dev.temp, type="response") |> pairs(by="dev.temp") |> summary()
```

## probabilities 
```{r probabilities}
prob <- model1.re  |> emmeans(pairwise ~ region*dev.temp)
prob2 <- prob$contrasts |> gather_emmeans_draws()
prob2 %>% group_by(contrast) %>% dplyr::summarise(Prob = sum(.value>0)/n())

```
# {-}
