---
title: "06. Reproductive Metrics - Hatchling mass"
author: "Elliott Schmidt"
date: "`r Sys.Date()`"
output: 
  html_document: 
    toc: true  
    toc_depth: 4
    toc_float: true
    code_folding: show
    collapse: no
    df_print: paged
    fig_caption: yes
    fig_height: 4
    fig_width: 6
    highlight: monochrome
    theme: cerulean
    latex_engine: xelatex
--- 

# Scenario 

Within this chapter developmental plasticity was explored within _Acanthochromis polyacanthus_ that were collected from two different regions (i.e., low-latitude, Cairns, and high-latitude, Mackay). Fish were held in common garden experiments at 28.5 C. Reproductive meterics are only relevant to parental fish. Understanding potential differences in reproduction within fish from low- and high-latitude populations will provide basis of where juveniles are starting from. 

# Load packages 

```{r load-packages-1, warning=FALSE, message=FALSE}
library(tidyverse) # data manipulation
library(ggpubr) # figure arrangement 
library(brms) # Bayesian models
library(StanHeaders)# needed to run Bayesian models
library(rstan) # needed to run Bayesian models
library(standist) # needs to be installed 
library(bayesplot) # needed for MCMC diagnostics 
library(DHARMa) # model validation 
library(ggdist) # partial plots 
library(tidybayes) # partial plots 
library(broom.mixed) # model investigation
library(emmeans) # pairwise comparisons
library(rstanarm) # pairwise comparisons - need for emmeans
library(car) # for correlation analysis
```

# Set working directory 

```{r setwd-1, echo=FALSE}
knitr::opts_knit$set(root.dir="C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Chapter4_Latitude")
``` 

```{r setwd-2, echo=TRUE, eval=FALSE}
knitr::opts_knit$set(root.dir=working.dir)
```

# Import data 

Note that when making the datasheet, each clutch was designated an 'experimental_number' that is associated with which experiment(s) clutches were involved in, therefore when importing the data, we will filter data to give us only clutches that were used in the relevent 'developmental plasticity experiment'. We are also dropping one clutch that was found only when individuals hatched, meaning we don't know the clutch size, or hatching success

```{r import-data-1, message=FALSE}
hmass <- read_delim("import_files/hatchling_size_data_2022_2023.txt", 
    delim = "\t", escape_double = FALSE, 
    col_types = cols(SL = col_skip(), ...24 = col_skip()), 
    trim_ws = TRUE)
```  

# Data manipulation 

```{r data-manipulation, warning=FALSE}
clutch_data <- read_delim("import_files/clutch_data_2022_2023.txt", 
    delim = "\t", escape_double = FALSE, 
    trim_ws = TRUE) |> 
  mutate(PROJECT_CODE = factor(PROJECT_CODE), 
         CLUTCH_NUMBER = factor(CLUTCH_NUMBER)) |>
  filter(PROJECT_CODE == "2"| 
         PROJECT_CODE == "3"|
         PROJECT_CODE == "6"|
         PROJECT_CODE == "7") |> 
  drop_na(EGG_COUNT)

clutch_data2 <- clutch_data |> 
  mutate(CLUTCH_NUMBER = as.factor(CLUTCH_NUMBER), 
         MALE = factor(MALE), 
         FEMALE = factor(FEMALE), 
         REGION = factor(REGION), 
         POPULATION = factor(POPULATION),
         CLUTCH_ORDER = factor(CLUTCH_ORDER),
         DATE_OF_HATCH = as.Date(DATE_OF_HATCH, format = "%d/%m/%Y"),
         FEMALE_MASS = coalesce(FEMALE_MASS, MALE_MASS))

hmass2 <- hmass |> 
  mutate(CLUTCH_NUMBER = factor(CLUTCH_NUMBER), 
         MALE = factor(MALE), 
         FEMALE = factor(FEMALE), 
         REGION = factor(REGION), 
         POPULATION = factor(POPULATION),
         CLUTCH_ORDER = factor(CLUTCH_ORDER),
         FEMALE_MASS = coalesce(FEMALE_MASS, MALE_MASS), 
         LEVEL = as.factor(case_when(TANK >= 1 & TANK <= 199 ~ 1,
                           TANK >= 200 & TANK <= 299 ~ 2,
                           TANK >= 300 & TANK <= 399 ~ 3,
                           TRUE ~ NA_real_))) |> 
  drop_na(MASS) |> 
  left_join(select(clutch_data2, c("CLUTCH_NUMBER","EGG_COUNT","HATCHING_SUCCESS","HATCHLINGS")), by="CLUTCH_NUMBER") |> 
  drop_na(EGG_COUNT) 


```  

# Exploratory data analysis 

```{r eda-1, warning=FALSE, message=FALSE, echo=FALSE, fig.width=9, fig.height=5}
p1 <- ggplot(hmass2, aes(x=REGION, y=MASS, fill=REGION)) + 
  geom_boxplot() + 
  theme_classic() 

p2 <- ggplot(hmass2, aes(x=REGION, y=MASS, fill=REGION)) + 
  geom_violin() + 
  theme_classic()  

p3 <- ggplot(hmass2, aes(x=REGION, y=MASS, fill=REGION)) + 
  geom_jitter() + 
  theme_classic()  

p4 <- ggplot(hmass2, aes(x=MASS)) + 
  geom_density()

ggarrange(p1,p2,p3,p4, 
          nrow=2, 
          ncol=2)
```

# Prior investigation 

```{r prior investigation}
hmass2 |> 
  group_by(REGION) |> 
  summarise(mean(na.omit(MASS)), 
            sd(na.omit(MASS)))
```
# Priors 

```{r priors}
hmass.priors <- prior(normal(0.00429, 0.001), class="Intercept")
```

# Fit model [random effects] {.tabset}

Hypothesis test will include:

0. Null model
1. MASS ~ 1 + (1| FEMALE)
2. MASS ~ 1 + (1| FEMALE) + (1| POPULATION)
3. MASS ~ 1 + (1| FEMALE) + (1| CLUTCH_ORDER)
4. MASS ~ 1 + (1| FEMALE) + (1| POPULATION) + (1| CLUTCH_ORDER) 
5. MASS ~ 1 + (1| FEMALE) + (1| POPULATION) + (1| CLUTCH_ORDER) + (1| LEVEL) + (1| TANK)

## null model
```{r null-model, cache=TRUE}
f.null.model <- bf(MASS ~ 1, 
                   family=gaussian()) 

null.model <- brm(f.null.model, 
                  data=hmass2, 
                  prior=hmass.priors, 
                  warmup = 500, 
                  iter=5000, 
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior ='yes', 
                  chains=2, 
                  thin=5, 
                  control = list(adapt_delta=0.95))
```
## model1

```{r model1, cache=TRUE}
f.model1 <- bf(MASS ~ 1 + (1| FEMALE), 
                   family=gaussian()) 

model1 <- brm(f.model1, 
                  data=hmass2, 
                  prior=hmass.priors, 
                  warmup = 500, 
                  iter=5000, 
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior ='yes', 
                  chains=2, 
                  thin=5, 
                  control = list(adapt_delta=0.95))
```

## model2

```{r model2, cache=TRUE}
f.model2 <- bf(MASS ~ 1 + (1| FEMALE) + (1| POPULATION), 
                   family=gaussian()) 

model2 <- brm(f.model2, 
                  data=hmass2, 
                  prior=hmass.priors, 
                  warmup = 500, 
                  iter=5000, 
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior ='yes', 
                  chains=2, 
                  thin=5, 
                  control = list(adapt_delta=0.95))
```

## model3

```{r model3, cache=TRUE}
f.model3 <- bf(MASS ~ 1 + (1| FEMALE) + (1| CLUTCH_ORDER), 
                   family=gaussian()) 

model3 <- brm(f.model3, 
                  data=hmass2, 
                  prior=hmass.priors, 
                  warmup = 500, 
                  iter=5000, 
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior ='yes', 
                  chains=2, 
                  thin=5, 
                  control = list(adapt_delta=0.95))
```

## model4

```{r model4, cache=TRUE}
f.model4 <- bf(MASS ~ 1 + (1| FEMALE) + (1| POPULATION) + (1| CLUTCH_ORDER), 
                   family=gaussian()) 

model4 <- brm(f.model4, 
                  data=hmass2, 
                  prior=hmass.priors, 
                  warmup = 500, 
                  iter=5000, 
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior ='yes', 
                  chains=2, 
                  thin=5, 
                  control = list(adapt_delta=0.95))
```

## LOO 
```{r model comparison}
LOO(null.model, model1, model2, model3, model4)
```

## {-}

# Fit model [fixed factors] 

## Collinearity 
```{r }
col.lm <- lm(MASS ~ 1 + REGION +
               scale(FEMALE_MASS, center=TRUE, scale=TRUE) +
               scale(DAYS_IN_TREATMENT, center=TRUE, scale=TRUE) + 
               CLUTCH_ORDER, 
                data = hmass2)
vif(col.lm)
``` 

## Prior investigation 
```{r }
hmass2 |> 
  group_by(REGION) |> 
  summarise(mean(na.omit(MASS)), 
            sd(na.omit(MASS))) 
```

## Priors
```{r }
mass.priors <- prior(normal(0.0043, 0.0001), class="Intercept") +  
  prior(normal(0, 0.0005), class="b") + 
  prior(student_t(3, 0, 0.0015), class = "sigma")
```

## Models {.tabset}

### Model1.1 {.tabset}

#### Model1.1 

```{r model1.1, cache=TRUE}
f.model1.1 <- bf(MASS ~ 1 + REGION + 
                   scale(FEMALE_MASS, center = TRUE, scale = TRUE) + 
                   (1| FEMALE) + (1| POPULATION) + (1| CLUTCH_ORDER), 
                 family=gaussian()) 

model1.1 <- brm(f.model1.1, 
                data =hmass2, 
                prior =mass.priors, 
                warmup = 500, 
                  iter = 5000,
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior = "yes",
                  chains = 2, 
                  thin = 10, 
                  control = list(adapt_delta=0.95))
saveRDS(model1.1, file="./06.Hatchling_size_files/model1.1.RDS")
```

#### DHARMa
```{r model1.1-DHARMa}
#--- distribution check ---#
pp_check(model1.1, type = 'dens_overlay_grouped', ndraws=150, group="REGION")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.1 , ndraws=250, summary=FALSE)
model1.1_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = hmass2$MASS, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.1_resids) ; testDispersion(model1.1_resids)
```

#### MCMC Diagnostics

```{r model1.1-mcmc-diag, fig.height=9}
stan_trace(model1.1$fit)
stan_ac(model1.1$fit) 
stan_rhat(model1.1$fit) 
stan_ess(model1.1$fit)
stan_dens(model1.1$fit, separate_chains = TRUE)

pairs(model1.1)
```

#### {-}

### Model1.2 {.tabset} 

#### model1.2
```{r model1.2, cache=TRUE}
f.model1.2 <- bf(MASS ~ 1 + REGION + 
                   scale(FEMALE_MASS, center = TRUE, scale = TRUE) +
                   (1| FEMALE) + (1| POPULATION) + (1| CLUTCH_ORDER), 
                 family=gaussian()) 

model1.2 <- brm(f.model1.1, 
                data =hmass2, 
                prior =mass.priors, 
                warmup = 1000, 
                  iter = 10000,
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior = "yes",
                  chains = 2, 
                  thin = 20, 
                  control = list(adapt_delta=0.95, max_treedepth=15))
saveRDS(model1.2, file="./06.Hatchling_size_files/model1.2.RDS")
```

#### DHARMa
```{r model1.2-DHARMa}
#--- distribution check ---#
pp_check(model1.2, type = 'dens_overlay_grouped', ndraws=150, group="REGION")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.2 , ndraws=250, summary=FALSE)
model1.2_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = hmass2$MASS, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.2_resids) ; testDispersion(model1.2_resids)
```

#### MCMC Diagnostics

```{r model1.2-mcmc-diag, fig.height=9}
stan_trace(model1.2$fit)
stan_ac(model1.2$fit) 
stan_rhat(model1.2$fit) 
stan_ess(model1.2$fit)
stan_dens(model1.2$fit, separate_chains = TRUE)
```

#### {-}

### Model1.3 {.tabset}

```{r }
mass.priors.gamma <- prior(normal(0.0043, 0.0001), class="Intercept") +  
  prior(normal(0, 0.0005), class="b") 
```

#### model1.3 

```{r model1.3, cache=TRUE}
f.model1.3 <- bf(MASS ~ 1 + REGION + 
                   scale(FEMALE_MASS, center = TRUE, scale = TRUE) + 
                   (1| FEMALE) + (1| POPULATION) + (1| CLUTCH_ORDER), 
                 family=Gamma(link="log")) 

model1.3 <- brm(f.model1.3, 
                data =hmass2, 
                prior =mass.priors.gamma, 
                warmup = 500, 
                  iter = 5000,
                  seed=123, 
                  cores=2, 
                  save_pars = save_pars(all=TRUE), 
                  sample_prior = "yes",
                  chains = 2, 
                  thin = 10, 
                  control = list(adapt_delta=0.95))
saveRDS(model1.3, file="./06.Hatchling_size_files/model1.3.RDS")
```

#### DHARMa
```{r model1.3-DHARMa}
#--- distribution check ---#
pp_check(model1.3, type = 'dens_overlay_grouped', ndraws=150, group="REGION")

#--- DHARMa checks ---#
preds <- posterior_predict(model1.3 , ndraws=250, summary=FALSE)
model1.3_resids <- createDHARMa(simulatedResponse = t(preds), 
                              observedResponse = hmass2$MASS, 
                              fittedPredictedResponse = apply(preds, 2, mean), 
                              integerResponse = 'student')
plot(model1.3_resids) ; testDispersion(model1.3_resids)
```

#### MCMC Diagnostics

```{r model1.3-mcmc-diag, fig.height=9}
stan_trace(model1.3$fit)
stan_ac(model1.3$fit) 
stan_rhat(model1.3$fit) 
stan_ess(model1.3$fit)
stan_dens(model1.3$fit, separate_chains = TRUE)
```

#### {-} 

### {-}

# partial plots 

```{r partial-plots-cond-eff-1}
model1.2 |> conditional_effects(spaghetti = TRUE, ndraws=200) 
```

# Model investigation {.tabset .tabset-pills}

## summary 

```{r summary-100}
summary(model1.2)
```

## R2 

```{r r-squared}
model1.2 |> bayes_R2(summary = FALSE) |> median_hdci()
```

## tidyMCMC 

```{r tidy}
tidyMCMC(model1.2, estimate.method='median', conf.int=TRUE, conf.method='HPDinterval')
```

## gather draws 

```{r gather_draws}
#model1.2 |> get_variables()
model1.2 |> gather_draws(`b_.*|sigma`, regex =TRUE) |> 
  median_hdci()
``` 

## bayesplot 

```{r bayesplot-1}
model1.2 |> mcmc_plot(type='intervals')
```

## emmeans - pariwise 

```{r emmeans-pairwise}
model1.2 |> emmeans(pairwise ~ REGION, type="response") |> pairs() |> summary()
model1.2 |> emmeans(pairwise ~ REGION, type="response") 
```

## probabilities 
```{r probabilities}
mtsqst <- model1.2 |> emmeans(pairwise ~ REGION)
mtsqrt1 <- mtsqst$contrasts |> gather_emmeans_draws()
mtsqrt1 %>% group_by(contrast) %>% dplyr::summarise(Prob = sum(.value>0)/n())
``` 

## {-}

# Summary plot
```{r summary-plot, warning=FALSE}
var <- get_variables(model1.2)
var1 <- get_variables(model1.2)[c(1:2)] 

int_draws_spread <- model1.2 |> spread_draws(!!!syms(var1)) 

int_draws_spread2 <- int_draws_spread |> 
  gather_draws(b_Intercept, b_REGIONleading) |> 
  left_join(int_draws_spread, by = c(".chain",".iteration",".draw"))


int_draws <- int_draws_spread2 |> 
  mutate(RCore = case_when(`.variable` == 'b_Intercept' ~ 
                             `.value`, 
                           `.variable` != 'b_Intercept' ~ 
                             `.value` + b_Intercept), 
         
         RLeading = case_when(`.variable` == 'b_Intercept' ~ 
                           `.value` + b_REGIONleading, 
                         `.variable` == 'b_REGIONleading' ~ 
                           `.value` + b_Intercept + `b_REGIONleading`))

int_draws_plotting <- int_draws |> 
  pivot_longer(cols = starts_with("R"), 
               names_to = "REGION", 
               values_to = "HATCHLING_MASS") |> 
  transmute(LATITUDE = case_when(`.variable` == "b_Intercept" ~ "Low latitude", 
                                 `.variable` == "b_REGIONleading" ~ "High latitude"),
            HATCHLING_MASS = HATCHLING_MASS, 
            LATITUDE_B = LATITUDE,
            chain = `.chain`, 
            iteration = `.iteration`, 
            draw_n = `.draw`) 

hatchling.size.plot <- int_draws_plotting |> 
  ggplot(aes(x=LATITUDE, y=HATCHLING_MASS)) + 
  #geom_hline(yintercept = 0, linetype="dashed", linewidth=1, color="grey58", alpha=0.8) + 
  stat_halfeye(aes(fill = LATITUDE, fill_ramp = after_stat(level)), 
               point_interval = mode_hdci, 
               .width = c(.66, .89, .95)) + 
  scale_fill_ramp_discrete(na.translate=FALSE, 
                           labels =c("0.95","0.89","0.66"), 
                           name = "Credible interval") +
  scale_fill_manual(values = c("lightskyblue","coral"))+ 
  #scale_y_continuous(limits=c(0,2), breaks = seq(0,2, .5))+
  ylab("HATCHLING_MASS") + xlab("EXPERIMENTAL GROUP") +
  scale_x_discrete(labels = c("Low latitude" = paste0("Low latitude"), 
                              "High latitude" = paste0("High latitude"))) +
  #annotate("text", x=6.8,y=1.4, label = paste0(round(mean(growth3$MASS), 2)," (mm)"), color="grey58") +
  coord_flip() + 
  theme_classic() + 
  guides(fill = "none") + 
  theme(legend.position = c(.15,.86), 
        axis.title.y = element_text(margin = margin(r =0.3, unit = "in"), size = 12), 
        axis.title.x = element_text(margin = margin(t = 0.3, unit="in"), size =12), 
        legend.key = element_rect(color="black", size=1.25), 
        legend.background = element_rect(fill = alpha("blue", 0))); hatchling.size.plot 
```

